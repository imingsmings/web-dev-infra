{"doc":{"isMarkdown":true,"isTranslated":false,"isActive":true,"flaws":{},"title":"Speculation Rules API","mdn_url":"/en-US/docs/Web/API/Speculation_Rules_API","locale":"en-US","native":"English (US)","browserCompat":["html.elements.script.type.speculationrules"],"sidebarHTML":"<ol><li><strong><em><a href=\"/en-US/docs/Web/API/Speculation_Rules_API\" aria-current=\"page\">Speculation Rules API</a></em></strong></li><li class=\"toggle\"><details open=\"\"><summary>Properties</summary><ol><li><a href=\"/en-US/docs/Web/API/Document/prerendering\"><code>Document.prerendering</code></a></li><li><a href=\"/en-US/docs/Web/API/PerformanceNavigationTiming/activationStart\"><code>PerformanceNavigationTiming.activationStart</code></a></li><li><a href=\"/en-US/docs/Web/API/PerformanceResourceTiming/deliveryType\"><code>PerformanceResourceTiming.deliveryType</code></a></li></ol></details></li><li class=\"toggle\"><details open=\"\"><summary>Events</summary><ol><li><a href=\"/en-US/docs/Web/API/Document/prerenderingchange_event\"><code>Document</code>: <code>prerenderingchange</code></a></li></ol></details></li></ol>","sidebarMacro":"DefaultAPISidebar","body":[{"type":"prose","value":{"id":null,"title":null,"isH3":false,"content":"<div class=\"notecard experimental\" id=\"sect1\"><p><strong>Experimental:</strong> <strong>This is an <a href=\"/en-US/docs/MDN/Writing_guidelines/Experimental_deprecated_obsolete#experimental\">experimental technology</a></strong><br>Check the <a href=\"#browser_compatibility\">Browser compatibility table</a> carefully before using this in production.</p></div>\n<p>The <strong>Speculation Rules API</strong> is designed to improve performance for future navigations. It targets document URLs rather than specific resource files, and so makes sense for multi-page applications (MPAs) rather than single-page applications (SPAs).</p>\n<p>The Speculation Rules API provides an alternative to the widely-available <a href=\"/en-US/docs/Web/HTML/Attributes/rel/prefetch\"><code>&lt;link rel=\"prefetch\"&gt;</code></a> feature and is designed to supersede the Chrome-only deprecated <a href=\"/en-US/docs/Web/HTML/Attributes/rel/prerender\"><code>&lt;link rel=\"prerender\"&gt;</code></a> feature. It provides many improvements over these technologies, along with a more expressive, configurable syntax for specifying which documents should be prefetched or prerendered.</p>\n<div class=\"notecard note\" id=\"sect2\">\n  <p><strong>Note:</strong> The Speculation Rules API doesn't handle subresource prefetches; for that you'll need to use <code>&lt;link rel=\"prefetch\"&gt;</code>.</p>\n</div>"}},{"type":"prose","value":{"id":"concepts_and_usage","title":"Concepts and usage","isH3":false,"content":"<p>Speculation rules are specified inside <a href=\"/en-US/docs/Web/HTML/Element/script/type/speculationrules\"><code>&lt;script type=\"speculationrules\"&gt; ... &lt;/script&gt;</code></a>. The rules are specified as a JSON structure.</p>\n<p>For example:</p>\n<div class=\"code-example\"><p class=\"example-header\"><span class=\"language-name\">html</span></p><pre class=\"brush: html notranslate\"><code><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span> <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>speculationrules<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">&gt;</span></span><span class=\"token script\"><span class=\"token language-javascript\">\n  <span class=\"token punctuation\">{</span>\n    <span class=\"token string-property property\">\"prerender\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n      <span class=\"token punctuation\">{</span>\n        <span class=\"token string-property property\">\"source\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"list\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string-property property\">\"urls\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"extra.html\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"extra2.html\"</span><span class=\"token punctuation\">]</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string-property property\">\"prefetch\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n      <span class=\"token punctuation\">{</span>\n        <span class=\"token string-property property\">\"source\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"list\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string-property property\">\"urls\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"next.html\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"next2.html\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string-property property\">\"requires\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"anonymous-client-ip-when-cross-origin\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string-property property\">\"referrer_policy\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"no-referrer\"</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">}</span>\n</span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">&gt;</span></span>\n</code></pre></div>\n<p>You specify a different array to contain the rules for each speculative loading type (for example <code>\"prerender\"</code> or <code>\"prefetch\"</code>). Each rule is contained in an object that specifies for example a list of resources to be fetched, plus options such as an explicit <a href=\"/en-US/docs/Web/HTTP/Headers/Referrer-Policy\"><code>Referrer-Policy</code></a> setting for each rule. Note that prerendered URLs are also prefetched.</p>\n<p>See <a href=\"/en-US/docs/Web/HTML/Element/script/type/speculationrules\"><code>&lt;script type=\"speculationrules\"&gt;</code></a> for a full explanation of the available syntax.</p>\n<div class=\"notecard note\" id=\"sect3\">\n  <p><strong>Note:</strong> As speculation rules use a <code>&lt;script&gt;</code> element, they need to be explicitly allowed in the <a href=\"/en-US/docs/Web/HTTP/Headers/Content-Security-Policy\"><code>Content-Security-Policy</code></a> <a href=\"/en-US/docs/Web/HTTP/Headers/Content-Security-Policy/script-src\"><code>script-src</code></a> directive if the site includes it. This is done by adding the <code>'inline-speculation-rules'</code> source along with a hash- or nonce-source.</p>\n</div>"}},{"type":"prose","value":{"id":"using_prefetching","title":"Using prefetching","isH3":true,"content":"<p>Including <code>prefetch</code> rules inside <code>&lt;script type=speculationrules&gt; ... &lt;/script&gt;</code> will cause supporting browsers to download the response body of the referenced pages, but none of the subresources referenced by the page. When a prefetched page is navigated to, it will render much more quickly than if it were not prefetched.</p>\n<p>The results are kept in a per-document in-memory cache. Any cached prefetches are discarded when you navigate away from the current page, except of course a prefetched document that you then navigate to.</p>\n<p>This means that if you prefetch something the user doesn't navigate to, it is generally a waste of resources, although the result may populate the HTTP cache if headers allow. That said, the upfront cost of a prefetch is much smaller than the upfront cost of a prerender, so you are encouraged to adopt prefetching broadly, for example prefetching all of the significant pages on your site, provided they are safe to prefetch (see <a href=\"#unsafe_speculative_loading_conditions\">Unsafe speculative loading conditions</a> for more details).</p>\n<p>Same-site and cross-site prefetches will work, but cross-site prefetches are limited (see <a href=\"https://web.dev/articles/same-site-same-origin#same-site-cross-site\" class=\"external\" target=\"_blank\">\"same-site\" and \"cross-site\"</a> for an explanation of the difference between the two). For privacy reasons cross-site prefetches will currently only work if the user has no cookies set for the destination site â€” we don't want sites to be able to track user activity via prefetched pages (which they may never even actually visit) based on previously-set cookies.</p>\n<div class=\"notecard note\" id=\"sect4\">\n  <p><strong>Note:</strong> In the future an opt-in will be provided via the <a href=\"/en-US/docs/Web/HTTP/Headers/Supports-Loading-Mode\"><code>Supports-Loading-Mode</code></a> header, but this was not implemented at the time of writing.</p>\n</div>\n<p>For browsers that support it, speculation rules prefetch should be preferred over older prefetch mechanisms, namely <a href=\"/en-US/docs/Web/HTML/Attributes/rel/prefetch\"><code>&lt;link rel=\"prefetch\"&gt;</code></a> and <a href=\"/en-US/docs/Web/API/fetch\"><code>fetch()</code></a> with a <code>priority: \"low\"</code> option set on it. Because we know that speculation rules prefetch is for navigations, not general resource prefetching:</p>\n<ul>\n  <li>It can be used for cross-site navigations, whereas <code>&lt;link rel=\"prefetch\"&gt;</code> cannot.</li>\n  <li>It doesn't get blocked by <a href=\"/en-US/docs/Web/HTTP/Headers/Cache-Control\">Cache-Control</a> headers, whereas <code>&lt;link rel=\"prefetch\"&gt;</code> often does.</li>\n</ul>\n<p>In addition, speculation rules prefetch:</p>\n<ul>\n  <li>Automatically lowers the priority when needed (<code>fetch()</code> doesn't).</li>\n  <li>Is respectful of the user's configuration. For example, prefetching doesn't happen when the user's device is in Battery Saver or Data Saver mode.</li>\n  <li>Stores the prefetched resources in a per-document in-memory cache as opposed to the HTTP cache, which may result in slightly faster prefetching.</li>\n</ul>"}},{"type":"prose","value":{"id":"using_prerendering","title":"Using prerendering","isH3":true,"content":"<p>Including <code>prerender</code> rules inside <code>&lt;script type=speculationrules&gt; ... &lt;/script&gt;</code> will cause supporting browsers to fetch, render, and load the content into an invisible tab, stored in a per-document in-memory cache. This includes loading all subresources, running all JavaScript, and even loading subresources and performing data fetches started by JavaScript. Any cached prerenders and their subresources are discarded when you navigate away from the current page, except of course a prerendered document that you then navigate to.</p>\n<p>Future navigations to a prerendered page will be near-instant. The browser activates the invisible tab instead of carrying out the usual navigation process, replacing the old foreground page with the prerendered page. If a page is activated before it has fully prerendered, it is activated in its current state and then continues to load, which means you will still see a significant performance improvement.</p>\n<p>Prerendering uses memory and network bandwidth. If you prerender something the user doesn't navigate to, these are wasted (although the result may populate the HTTP cache if headers allow, allowing later use). The upfront cost of a prerender is much larger than the upfront cost of a prefetch, and there are more conditions that could make content unsafe to prerender (see <a href=\"#unsafe_speculative_loading_conditions\">Unsafe speculative loading conditions</a> for more details). As a result, you are encouraged to adopt prerendering more sparingly, carefully considering cases where there is a high likelihood of the page being navigated to, and you think the user experience benefit is worth the extra cost.</p>\n<div class=\"notecard note\" id=\"sect5\">\n  <p><strong>Note:</strong> To put the amount of potential resource wastage in perspective, a prerender uses about the same amount of resources as rendering an <a href=\"/en-US/docs/Web/HTML/Element/iframe\"><code>&lt;iframe&gt;</code></a>.</p>\n</div>\n<div class=\"notecard note\" id=\"sect6\">\n  <p><strong>Note:</strong> Many APIs will be automatically deferred when prerendering/until activation. See <a href=\"#platform_features_deferred_or_restricted_during_prerender\">Platform features deferred or restricted during prerender</a> for more details.</p>\n</div>\n<p>Prerendering is restricted to same-origin documents by default. Cross-origin, same-site prerendering is possible â€” it requires the navigation target to opt-in using the <a href=\"/en-US/docs/Web/HTTP/Headers/Supports-Loading-Mode\"><code>Supports-Loading-Mode</code></a> header with a value of <code>credentialed-prerender</code>. Cross-site prerendering is not possible at this time.</p>\n<p>For browsers that support it, speculation rules prerender should be preferred over older prerender mechanisms, namely <a href=\"/en-US/docs/Web/HTML/Attributes/rel/prerender\"><code>&lt;link rel=\"prerender\"&gt;</code></a>:</p>\n<ul>\n  <li><code>&lt;link rel=\"prerender\"&gt;</code> is Chrome-specific and was never standardized, and the Chrome engineering team are in the process of sunsetting it. <abbr class=\"icon icon-experimental\" title=\"Experimental. Expect behavior to change in the future.\">\n    <span class=\"visually-hidden\">Experimental</span>\n</abbr></li>\n  <li>It loads subresources loaded via JavaScript, whereas <code>&lt;link rel=\"prerender\"&gt;</code> doesn't.</li>\n  <li>It doesn't get blocked by <a href=\"/en-US/docs/Web/HTTP/Headers/Cache-Control\">Cache-Control</a> settings, whereas <code>&lt;link rel=\"prerender\"&gt;</code> often does.</li>\n  <li>Speculation rules prerender should be treated as a hint and a progressive enhancement. Unlike <code>&lt;link rel=\"prerender\"&gt;</code>, it is a speculative hint and the browser may choose not to act upon the hint based on user settings, current memory usage, or other heuristics.</li>\n</ul>"}},{"type":"prose","value":{"id":"speculation_rules_api_feature_detection","title":"Speculation rules API feature detection","isH3":true,"content":"<p>You can check if the Speculation Rules API is supported using the following code:</p>\n<div class=\"code-example\"><p class=\"example-header\"><span class=\"language-name\">js</span></p><pre class=\"brush: js notranslate\"><code><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>\n  HTMLScriptElement<span class=\"token punctuation\">.</span>supports <span class=\"token operator\">&amp;&amp;</span>\n  HTMLScriptElement<span class=\"token punctuation\">.</span><span class=\"token function\">supports</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"speculationrules\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Your browser supports the Speculation Rules API.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>For example, you might want to insert speculation rules for prefetching in supporting browsers, but use an older technology such as <code>&lt;link rel=\"prefetch\"&gt;</code> in others:</p>\n<div class=\"code-example\"><p class=\"example-header\"><span class=\"language-name\">js</span></p><pre class=\"brush: js notranslate\"><code><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>\n  HTMLScriptElement<span class=\"token punctuation\">.</span>supports <span class=\"token operator\">&amp;&amp;</span>\n  HTMLScriptElement<span class=\"token punctuation\">.</span><span class=\"token function\">supports</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"speculationrules\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> specScript <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"script\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  specScript<span class=\"token punctuation\">.</span>type <span class=\"token operator\">=</span> <span class=\"token string\">\"speculationrules\"</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> specRules <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token literal-property property\">prefetch</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n      <span class=\"token punctuation\">{</span>\n        <span class=\"token literal-property property\">source</span><span class=\"token operator\">:</span> <span class=\"token string\">\"list\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token literal-property property\">urls</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"/next.html\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  specScript<span class=\"token punctuation\">.</span>textContent <span class=\"token operator\">=</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span>specRules<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  document<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span>specScript<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> linkElem <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"link\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  linkElem<span class=\"token punctuation\">.</span>rel <span class=\"token operator\">=</span> <span class=\"token string\">\"prefetch\"</span><span class=\"token punctuation\">;</span>\n  linkElem<span class=\"token punctuation\">.</span>href <span class=\"token operator\">=</span> <span class=\"token string\">\"/next.html\"</span><span class=\"token punctuation\">;</span>\n  document<span class=\"token punctuation\">.</span>head<span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span>linkElem<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>"}},{"type":"prose","value":{"id":"detecting_prefetched_and_prerendered_pages","title":"Detecting prefetched and prerendered pages","isH3":false,"content":"<p>This section looks at different ways to detect whether a requested page has been prefetched or prerendered.</p>"}},{"type":"prose","value":{"id":"server-side_detection","title":"Server-side detection","isH3":true,"content":"<p>Prefetched and prerendered page requests are sent with the <a href=\"/en-US/docs/Web/HTTP/Headers/Sec-Purpose\">Sec-Purpose</a> request header:</p>\n<p>For prefetch:</p>\n<div class=\"code-example\"><p class=\"example-header\"><span class=\"language-name\">http</span></p><pre class=\"brush: http notranslate\"><code><span class=\"token header\"><span class=\"token header-name keyword\">Sec-Purpose</span><span class=\"token punctuation\">:</span> <span class=\"token header-value\">prefetch</span></span>\n</code></pre></div>\n<p>For prerender:</p>\n<div class=\"code-example\"><p class=\"example-header\"><span class=\"language-name\">http</span></p><pre class=\"brush: http notranslate\"><code><span class=\"token header\"><span class=\"token header-name keyword\">Sec-Purpose</span><span class=\"token punctuation\">:</span> <span class=\"token header-value\">prefetch;prerender</span></span>\n</code></pre></div>\n<p>Servers can respond based on this header, for example to log speculative load requests, return different content, or even prevent the speculative loading from happening. If a non-success response code is returned (not 200 or 304), then the page will not be prefetched/prerendered. This is the easiest way to prevent speculative loading, although it is usually a better approach to allow the prefetch/prerender, but delay any actions that should only happen then the page is actually viewed, using JavaScript.</p>"}},{"type":"prose","value":{"id":"javascript_prefetch_detection","title":"JavaScript prefetch detection","isH3":true,"content":"<p>When a page is prefetched, its <a href=\"/en-US/docs/Web/API/PerformanceResourceTiming/deliveryType\"><code>PerformanceResourceTiming.deliveryType</code></a> entry will return a value of <code>\"navigational-prefetch\"</code>. You could use the following to run a function when a performance entry of type <code>\"navigational-prefetch\"</code> is received:</p>\n<div class=\"code-example\"><p class=\"example-header\"><span class=\"language-name\">js</span></p><pre class=\"brush: js notranslate\"><code><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>\n  performance<span class=\"token punctuation\">.</span><span class=\"token function\">getEntriesByType</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"navigation\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>deliveryType <span class=\"token operator\">===</span>\n  <span class=\"token string\">\"navigational-prefetch\"</span>\n<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">respondToPrefetch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// Author-defined function</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>This technique is useful when measuring performance, or when you want to defer actions that might cause problems if they occur during prefetching (see <a href=\"#unsafe_prefetching\">Unsafe prefetching</a>).</p>"}},{"type":"prose","value":{"id":"javascript_prerender_detection","title":"JavaScript prerender detection","isH3":true,"content":"<p>To run an activity while the page is prerendering, you can check for the <a href=\"/en-US/docs/Web/API/Document/prerendering\"><code>Document.prerendering</code></a> property. You could for example run some analytics:</p>\n<div class=\"code-example\"><p class=\"example-header\"><span class=\"language-name\">js</span></p><pre class=\"brush: js notranslate\"><code><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>document<span class=\"token punctuation\">.</span>prerendering<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  analytics<span class=\"token punctuation\">.</span><span class=\"token function\">sendInfo</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"got this far during prerendering!\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>When a prerendered document is activated, <a href=\"/en-US/docs/Web/API/PerformanceNavigationTiming/activationStart\"><code>PerformanceNavigationTiming.activationStart</code></a> is set to a <a href=\"/en-US/docs/Web/API/DOMHighResTimeStamp\"><code>DOMHighResTimeStamp</code></a> representing the time between when the prerender was started and the document was actually activated. The following function can check for prerendering <em>and</em> prerendered pages:</p>\n<div class=\"code-example\"><p class=\"example-header\"><span class=\"language-name\">js</span></p><pre class=\"brush: js notranslate\"><code><span class=\"token keyword\">function</span> <span class=\"token function\">pagePrerendered</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    document<span class=\"token punctuation\">.</span>prerendering <span class=\"token operator\">||</span>\n    self<span class=\"token punctuation\">.</span>performance<span class=\"token operator\">?.</span>getEntriesByType<span class=\"token operator\">?.</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"navigation\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token operator\">?.</span>activationStart <span class=\"token operator\">&gt;</span> <span class=\"token number\">0</span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>When the prerendered page is activated by the user viewing the page, the <a href=\"/en-US/docs/Web/API/Document/prerenderingchange_event\" title=\"prerenderingchange\"><code>prerenderingchange</code></a> event will fire. This can be used to enable activities that previously would be started by default on page load but which you wish to delay until the page is actually viewed by the user. The following code sets up an event listener to run a function once prerendering has finished, on a prerendered page, or runs it immediately on a non-prerendered page:</p>\n<div class=\"code-example\"><p class=\"example-header\"><span class=\"language-name\">js</span></p><pre class=\"brush: js notranslate\"><code><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>document<span class=\"token punctuation\">.</span>prerendering<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  document<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"prerenderingchange\"</span><span class=\"token punctuation\">,</span> initAnalytics<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token literal-property property\">once</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">initAnalytics</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>"}},{"type":"prose","value":{"id":"unsafe_speculative_loading_conditions","title":"Unsafe speculative loading conditions","isH3":false,"content":"<p>This section covers conditions to look out for, under which prefetching and/or prerendering are <strong>unsafe</strong>. This means that prefetching/prerendering pages that exhibit these conditions may require mitigations in your code, or need to be avoided altogether.</p>"}},{"type":"prose","value":{"id":"unsafe_prefetching","title":"Unsafe prefetching","isH3":true,"content":"<p>As mentioned earlier, we recommend adopting prefetching broadly, as the risk to reward ratio is fairly low â€” the potential for resource wastage is minimal, and the performance improvements can be significant. However, you need to make sure prefetched pages do not cause problems with the flow of your application.</p>\n<p>When a prefetch is done, the browser downloads the response body of the referenced page via a single GET request, which the user may navigate to at a future time. Problems can arise specifically when the URL of the request performs a server-initiated side effect that you don't want to happen until the URL is actually navigated to.</p>\n<p>For example:</p>\n<ul>\n  <li>Sign-out URLs.</li>\n  <li>Language switching URLs.</li>\n  <li>\"Add to cart\" URLs.</li>\n  <li>Sign-in flow URLs where the server causes an SMS to be sent, for example as a one-time password (OTP).</li>\n  <li>URLs that increment a user's usage allowance numbers, such as consuming their monthly free article allowance or starting the timer on their monthly minutes.</li>\n  <li>URLs that initiate server-side ad conversion tracking.</li>\n</ul>\n<p>Such issues can be mitigated on the server by watching for the <a href=\"/en-US/docs/Web/HTTP/Headers/Sec-Purpose\"><code>Sec-Purpose: prefetch</code></a> header as the requests come in, and then running specific code to defer problematic functionality. Later on, when the page is actually navigated to, you can initiate the deferred functionality via JavaScript if needed.</p>\n<div class=\"notecard note\" id=\"sect7\">\n  <p><strong>Note:</strong> You can find more details about the detection code in the <a href=\"#detecting_prefetched_and_prerendered_pages\">Detecting prefetched and prerendered pages</a> section.</p>\n</div>\n<p>If the functionality only occurs under normal circumstances when JavaScript runs, then prefetching is safe, since the JavaScript will not run until activation.</p>\n<p>It is also potentially risky to prefetch a document whose server-rendered contents will change due to actions the user can take on the current page. This could include, for example, flash sale pages or movie theater seat maps. Test such cases carefully, and mitigate such issues by updating content once the page is loaded. See <a href=\"#server-rendered_varying_state\">Server-rendered varying state</a> for more details about these cases.</p>\n<div class=\"notecard note\" id=\"sect8\">\n  <p><strong>Note:</strong> Browsers will cache prefetched pages for a short time (Chrome for example caches them for 5 minutes) before discarding them, so in any case, your users might see content that is up to 5 minutes out of date.</p>\n</div>\n<p>One final tip is to audit the URLs listed as disallowed in your <a href=\"/en-US/docs/Glossary/Robots.txt\"><code>Robots.txt</code></a> file â€” normally these URLs point to pages that can only be accessed by authenticated users, and therefore should not be included in search engine results. Many of these will be fine, but it can be a good place to find URLs unsafe for prefetching (i.e. they exhibit the conditions described above).</p>"}},{"type":"prose","value":{"id":"unsafe_prerendering","title":"Unsafe prerendering","isH3":true,"content":"<p>Prerendering is more risky to adopt than prefetching and should therefore be done more sparingly, in cases where it is worth it. There are more unsafe conditions to watch out for with prerendering so, while the reward is higher, the risk is too.</p>\n<p>When a prerender is done, the browser GETs the URL and renders and loads the content into an invisible tab. This includes running the content's JavaScript and loading all subresources, including those fetched by JavaScript. Content can be potentially unsafe to prerender if any of the following conditions are observed:</p>\n<ul>\n  <li>The URL is <a href=\"#unsafe_prefetching\">unsafe to prefetch</a>. Read the previous section first if you haven't already, and understand that these conditions also equally apply to unsafe prerendering.</li>\n  <li>The page's JavaScript modifies client-side storage (for example <a href=\"/en-US/docs/Web/API/Web_Storage_API\">Web Storage</a> or <a href=\"/en-US/docs/Web/API/IndexedDB_API\">IndexedDB</a>) on load in a way that may cause confusing effects in other, non-prerendered pages that the user is currently looking at.</li>\n  <li>The page runs JavaScript or loads images that cause side effects such as sending analytics, recording ad impressions, or otherwise modifying the state of the application as if the user had already interacted with it. Again, this can affect the flow of the application, or cause incorrect performance or usage reporting. See <a href=\"#server-rendered_varying_state\">Server-rendered varying state</a> for more details about such use cases.</li>\n</ul>\n<p>To mitigate such problems, you can use the following techniques:</p>\n<ul>\n  <li>Watch for the <a href=\"/en-US/docs/Web/HTTP/Headers/Sec-Purpose\"><code>Sec-Purpose: prerender</code></a> header on the server as the requests come in, and then run specific code to defer problematic functionality.</li>\n  <li>Use the <a href=\"/en-US/docs/Web/API/Document/prerenderingchange_event\" title=\"prerenderingchange\"><code>prerenderingchange</code></a> event to detect when the prerendered page is actually activated and run code as a result. This is useful in two cases:\n    <ul>\n      <li>Deferring code that may cause problems if it is run before the page is viewed. For example, you may want to wait until after activation to update client-side storage or modify server-side state using JavaScript. This can avoid situations when the UI and the application state become out of sync with one another, for example a shopping cart showing no items even though the user has added some.</li>\n      <li>If the above is not possible, then you could still rerun code after the page is activated to bring the app up-to-date again. For example, a highly-dynamic flash sale page might rely on content updates coming in from a third-party library. If you can't delay the updates, you can always get fresh updates once the user views the page. Prerendered pages can be updated in real time using the <a href=\"/en-US/docs/Web/API/Broadcast_Channel_API\">Broadcast Channel API</a>, or another mechanism such as <a href=\"/en-US/docs/Web/API/fetch\"><code>fetch()</code></a> or a <a href=\"/en-US/docs/Web/API/WebSocket\"><code>WebSocket</code></a>. This guarantees that the user will see up-to-date content after prerendering activation.</li>\n    </ul>\n  </li>\n  <li>Manage your third-party analytics scripts carefully â€” if possible, use scripts that are prerendering-aware (for example use the <a href=\"/en-US/docs/Web/API/Document/prerendering\"><code>Document.prerendering</code></a> property to defer running on prerendering pages) such as Google Analytics or NewRelic.\n    <ul>\n      <li>Note that cross-origin <a href=\"/en-US/docs/Web/HTML/Element/iframe\"><code>&lt;iframe&gt;</code></a> loads are delayed while prerendering, therefore most other third-party widgets such as adtech are actually safe to use while prerendering.</li>\n      <li>For third-party scripts that are not prerendering-aware, avoid loading them until after activation using the <a href=\"/en-US/docs/Web/API/Document/prerenderingchange_event\" title=\"prerenderingchange\"><code>prerenderingchange</code></a> event, as mentioned earlier.</li>\n    </ul>\n  </li>\n</ul>"}},{"type":"prose","value":{"id":"server-rendered_varying_state","title":"Server-rendered varying state","isH3":true,"content":"<p>There are two main types of server-rendered state to be concerned with: <strong>outdated state</strong>, and <strong>user-specific state</strong>. This can cause both unsafe prefetching and prerendering.</p>\n<ul>\n  <li>Outdated state: Consider the example of a server-rendered list of blog comments, which may become out of date between the blog post being prerendered, and it being viewed. This might be particularly problematic if the current page is an admin panel where the user is deleting spam comments. If the user then navigates to the blog post, they might be confused as to why they can see the spam comments they just deleted.</li>\n  <li>User-specific state: Consider the example of tracking sign-in state via a cookie. Problems can arise like the following:\n    <ul>\n      <li>The user visits <code>https://site.example/a</code> in tab 1 and <code>https://site.example/b</code> in tab 2, while logged out.</li>\n      <li><code>https://site.example/b</code> prerenders <code>https://site.example/c</code>. It will be prerendered in a logged-out state.</li>\n      <li>The user signs in to <code>https://site.example</code> in tab 1.</li>\n      <li>The user switches to tab 2 and clicks the link to <code>https://site.example/c</code>, which activates the prerendered page.</li>\n      <li>Tab 2 displays a signed-out view of <code>https://site.example/c</code>, which confuses the user since they thought they were logged in.</li>\n    </ul>\n  </li>\n</ul>\n<p>User-specific state problems can occur for other user settings, for example language settings, dark-mode preferences, or adding items to a cart. They can also occur when only a single tab is involved:</p>\n<ul>\n  <li>Let's say the user visits <code>https://site.example/product</code>.</li>\n  <li><code>https://site.example.com/product</code> prerenders <code>https://site.example.com/cart</code>. It prerenders with 0 items in the cart.</li>\n  <li>The user clicks on the \"Add to cart\" buttons, which initiates a fetch request to add the item to the user's cart (with no page reload).</li>\n  <li>The user clicks on the link to <code>https://site.example.com/cart</code>, which activates the prerendered page.</li>\n  <li>The user sees an empty cart, even though they just added something to it.</li>\n</ul>\n<p>The best mitigation for these cases, and indeed any time when content can get out of sync with the server, is for pages to refresh themselves as needed. For example, a server might use the <a href=\"/en-US/docs/Web/API/Broadcast_Channel_API\">Broadcast Channel API</a>, or another mechanism such as <a href=\"/en-US/docs/Web/API/fetch\"><code>fetch()</code></a> or a <a href=\"/en-US/docs/Web/API/WebSocket\"><code>WebSocket</code></a>. Pages can then update themselves appropriately, including speculatively loaded pages that have not yet activated.</p>"}},{"type":"prose","value":{"id":"session_history_behavior_for_prerendered_documents","title":"Session history behavior for prerendered documents","isH3":false,"content":"<p>Activating a prerendering/prerendered document behaves like any conventional navigation, from the end-user perspective. The activated document is displayed in the tab and appended to session history, and any existing forward history entries are pruned. Any navigations taking place within the prerendering browsing context <em>before</em> activation do not affect the session history.</p>\n<p>From the developer's perspective, a prerendering document can be thought of as having a <strong>trivial session history</strong> where only one entry â€” the current entry â€” exists. All navigations within the prerendering context are effectively replaced.</p>\n<p>While API features that operate on session history (for example <a href=\"/en-US/docs/Web/API/History\"><code>History</code></a> and <a href=\"/en-US/docs/Web/API/Navigation\"><code>Navigation</code></a>) can be called within prerendering documents, they only operate on the context's trivial session history. Consequently, prerendering documents do not take part in their referring page's joint session history. For example, they cannot navigate their referrer via <a href=\"/en-US/docs/Web/API/History/back\"><code>History.back()</code></a>.</p>\n<p>This design ensures that users get the expected experience when using the back button â€” i.e. that they are taken back to the last thing they saw. Once a prerendering document is activated, only a single session history entry gets appended to the joint session history, ignoring any previous navigations that happened within the prerendering browsing context. Going back one step in the joint session history â€” for example by pressing the back button â€” takes the user back to the referrer page.</p>"}},{"type":"prose","value":{"id":"platform_features_deferred_or_restricted_during_prerender","title":"Platform features deferred or restricted during prerender","isH3":false,"content":"<p>Because a prerendered page is opened in a hidden state, a number of APIs and other web platform features that cause potentially intrusive behaviors are not activated in this state, and are instead deferred until the page is activated or restricted altogether. In the small number of cases where this is not yet possible, the prerender is canceled.</p>"}},{"type":"prose","value":{"id":"asynchronous_api_deferral","title":"Asynchronous API deferral","isH3":true,"content":"<p>The following asynchronous features' results are deferred in prerendered documents until they are activated:</p>\n<ul>\n  <li><a href=\"/en-US/docs/Web/API/Audio_Output_Devices_API\">Audio Output Devices API</a>: <a href=\"/en-US/docs/Web/API/MediaDevices/selectAudioOutput\"><code>MediaDevices.selectAudioOutput()</code></a></li>\n  <li><a href=\"/en-US/docs/Web/API/Background_Fetch_API\">Background Fetch API</a>: <a href=\"/en-US/docs/Web/API/BackgroundFetchManager/fetch\"><code>BackgroundFetchManager.fetch()</code></a></li>\n  <li><a href=\"/en-US/docs/Web/API/Broadcast_Channel_API\">Broadcast Channel API</a>: <a href=\"/en-US/docs/Web/API/BroadcastChannel/postMessage\"><code>BroadcastChannel.postMessage()</code></a></li>\n  <li><a href=\"/en-US/docs/Web/API/Credential_Management_API\">Credential Management API</a>: <a href=\"/en-US/docs/Web/API/CredentialsContainer/create\"><code>CredentialsContainer.create()</code></a>, <a href=\"/en-US/docs/Web/API/CredentialsContainer/get\"><code>CredentialsContainer.get()</code></a>, <a href=\"/en-US/docs/Web/API/CredentialsContainer/store\"><code>CredentialsContainer.store()</code></a></li>\n  <li><a href=\"/en-US/docs/Web/API/Encrypted_Media_Extensions_API\">Encrypted Media Extensions API</a>: <a href=\"/en-US/docs/Web/API/Navigator/requestMediaKeySystemAccess\"><code>Navigator.requestMediaKeySystemAccess()</code></a></li>\n  <li><a href=\"/en-US/docs/Web/API/Gamepad_API\">Gamepad API</a>: <a href=\"/en-US/docs/Web/API/Navigator/getGamepads\"><code>Navigator.getGamepads()</code></a>, <a href=\"/en-US/docs/Web/API/Window/gamepadconnected_event\" title=\"gamepadconnected\"><code>gamepadconnected</code></a> event, <a href=\"/en-US/docs/Web/API/Window/gamepaddisconnected_event\" title=\"gamepaddisconnected\"><code>gamepaddisconnected</code></a> event</li>\n  <li><a href=\"/en-US/docs/Web/API/Geolocation_API\">Geolocation API</a>: <a href=\"/en-US/docs/Web/API/Geolocation/getCurrentPosition\"><code>Geolocation.getCurrentPosition()</code></a>, <a href=\"/en-US/docs/Web/API/Geolocation/watchPosition\"><code>Geolocation.watchPosition()</code></a>, <a href=\"/en-US/docs/Web/API/Geolocation/clearWatch\"><code>Geolocation.clearWatch()</code></a></li>\n  <li><a href=\"/en-US/docs/Web/API/HTMLMediaElement\"><code>HTMLMediaElement</code></a> API: The playback position will not advance while the containing document is prerendering</li>\n  <li><a href=\"/en-US/docs/Web/API/Idle_Detection_API\">Idle Detection API</a>: <a href=\"/en-US/docs/Web/API/IdleDetector/start\"><code>IdleDetector.start()</code></a></li>\n  <li><a href=\"/en-US/docs/Web/API/Media_Capture_and_Streams_API\">Media Capture and Streams API</a>: <a href=\"/en-US/docs/Web/API/MediaDevices/getUserMedia\"><code>MediaDevices.getUserMedia()</code></a> (and the legacy <a href=\"/en-US/docs/Web/API/Navigator/getUserMedia\"><code>Navigator.getUserMedia()</code></a> version), <a href=\"/en-US/docs/Web/API/MediaDevices/enumerateDevices\"><code>MediaDevices.enumerateDevices()</code></a></li>\n  <li><a href=\"/en-US/docs/Web/API/Notifications_API\">Notifications API</a>: <a href=\"/en-US/docs/Web/API/Notification/Notification\" title=\"Notification()\"><code>Notification()</code></a> constructor, <a href=\"/en-US/docs/Web/API/Notification/requestPermission_static\" title=\"Notification.requestPermission()\"><code>Notification.requestPermission()</code></a></li>\n  <li><a href=\"/en-US/docs/Web/API/Push_API\">Push API</a>: <a href=\"/en-US/docs/Web/API/PushManager/subscribe\"><code>PushManager.subscribe()</code></a></li>\n  <li><a href=\"/en-US/docs/Web/API/Screen_Orientation_API\">Screen Orientation API</a>: <a href=\"/en-US/docs/Web/API/ScreenOrientation/lock\"><code>ScreenOrientation.lock()</code></a>, <a href=\"/en-US/docs/Web/API/ScreenOrientation/unlock\"><code>ScreenOrientation.unlock()</code></a></li>\n  <li><a href=\"/en-US/docs/Web/API/Sensor_APIs\">Sensor APIs</a>: <a href=\"/en-US/docs/Web/API/Sensor/start\"><code>Sensor.start()</code></a></li>\n  <li><a href=\"/en-US/docs/Web/API/Service_Worker_API\">Service Worker API</a>: <a href=\"/en-US/docs/Web/API/ServiceWorker/postMessage\"><code>ServiceWorker.postMessage()</code></a>, <a href=\"/en-US/docs/Web/API/ServiceWorkerContainer/register\"><code>ServiceWorkerContainer.register()</code></a>, <a href=\"/en-US/docs/Web/API/ServiceWorkerRegistration/update\"><code>ServiceWorkerRegistration.update()</code></a>, <a href=\"/en-US/docs/Web/API/ServiceWorkerRegistration/unregister\"><code>ServiceWorkerRegistration.unregister()</code></a></li>\n  <li><a href=\"/en-US/docs/Web/API/Storage_API\">Storage API</a>: <a href=\"/en-US/docs/Web/API/StorageManager/persist\"><code>StorageManager.persist()</code></a></li>\n  <li><a href=\"/en-US/docs/Web/API/Web_Audio_API\">Web Audio API</a>: <a href=\"/en-US/docs/Web/API/AudioContext\"><code>AudioContext</code></a>s are not allowed to start while the containing document is prerendering</li>\n  <li><a href=\"/en-US/docs/Web/API/Web_Bluetooth_API\">Web Bluetooth API</a>: <a href=\"/en-US/docs/Web/API/Bluetooth/getDevices\"><code>Bluetooth.getDevices()</code></a>, <a href=\"/en-US/docs/Web/API/Bluetooth/requestDevice\"><code>Bluetooth.requestDevice()</code></a></li>\n  <li><a href=\"/en-US/docs/Web/API/WebHID_API\">WebHID API</a>: <a href=\"/en-US/docs/Web/API/HID/getDevices\"><code>HID.getDevices()</code></a>, <a href=\"/en-US/docs/Web/API/HID/requestDevice\"><code>HID.requestDevice()</code></a></li>\n  <li><a href=\"/en-US/docs/Web/API/Web_Locks_API\">Web Locks API</a>: <a href=\"/en-US/docs/Web/API/LockManager/query\"><code>LockManager.query()</code></a>, <a href=\"/en-US/docs/Web/API/LockManager/request\"><code>LockManager.request()</code></a></li>\n  <li><a href=\"/en-US/docs/Web/API/Web_MIDI_API\">Web MIDI API</a>: <a href=\"/en-US/docs/Web/API/Navigator/requestMIDIAccess\"><code>Navigator.requestMIDIAccess()</code></a></li>\n  <li><a href=\"/en-US/docs/Web/API/Web_NFC_API\">Web NFC API</a>: <a href=\"/en-US/docs/Web/API/NDEFReader/write\"><code>NDefReader.write()</code></a>, <a href=\"/en-US/docs/Web/API/NDEFReader/scan\"><code>NDefReader.scan()</code></a></li>\n  <li><a href=\"/en-US/docs/Web/API/Web_Serial_API\">Web Serial API</a>: <a href=\"/en-US/docs/Web/API/Serial/getPorts\"><code>Serial.getPorts()</code></a>, <a href=\"/en-US/docs/Web/API/Serial/requestPort\"><code>Serial.requestPort()</code></a></li>\n  <li><a href=\"/en-US/docs/Web/API/Web_Speech_API\">Web Speech API</a>: <a href=\"/en-US/docs/Web/API/SpeechRecognition/abort\"><code>SpeechRecognition.abort()</code></a>, <a href=\"/en-US/docs/Web/API/SpeechRecognition/start\"><code>SpeechRecognition.start()</code></a>, <a href=\"/en-US/docs/Web/API/SpeechRecognition/stop\"><code>SpeechRecognition.stop()</code></a>, <a href=\"/en-US/docs/Web/API/SpeechSynthesis/cancel\"><code>SpeechSynthesis.cancel()</code></a>, <a href=\"/en-US/docs/Web/API/SpeechSynthesis/pause\"><code>SpeechSynthesis.pause()</code></a>, <a href=\"/en-US/docs/Web/API/SpeechSynthesis/resume\"><code>SpeechSynthesis.resume()</code></a>, <a href=\"/en-US/docs/Web/API/SpeechSynthesis/speak\"><code>SpeechSynthesis.speak()</code></a></li>\n  <li><a href=\"/en-US/docs/Web/API/WebUSB_API\">WebUSB API</a>: <a href=\"/en-US/docs/Web/API/USB/getDevices\"><code>USB.getDevices()</code></a>, <a href=\"/en-US/docs/Web/API/USB/requestDevice\"><code>USB.requestDevice()</code></a></li>\n  <li><a href=\"/en-US/docs/Web/API/WebXR_Device_API\">WebXR Device API</a>: <a href=\"/en-US/docs/Web/API/XRSystem/requestSession\"><code>XRSystem.requestSession()</code></a></li>\n</ul>"}},{"type":"prose","value":{"id":"implicitly_restricted_apis","title":"Implicitly restricted APIs","isH3":true,"content":"<p>The following features will automatically fail or no-op in documents that are not activated.</p>\n<p>APIs that require <a href=\"/en-US/docs/Glossary/Transient_activation\">transient activation</a> or <a href=\"/en-US/docs/Glossary/Sticky_activation\">sticky activation</a>:</p>\n<ul>\n  <li>Confirmation dialogs generated by the <a href=\"/en-US/docs/Web/API/Window/beforeunload_event\" title=\"beforeunload\"><code>beforeunload</code></a> event</li>\n  <li>The firing of any events in the <a href=\"/en-US/docs/Web/API/Clipboard_API\">Clipboard API</a>.</li>\n  <li><a href=\"/en-US/docs/Web/API/File_System_API\">File System API</a>: <a href=\"/en-US/docs/Web/API/Window/showDirectoryPicker\"><code>Window.showDirectoryPicker()</code></a>, <a href=\"/en-US/docs/Web/API/Window/showOpenFilePicker\"><code>Window.showOpenFilePicker()</code></a>, <a href=\"/en-US/docs/Web/API/Window/showSaveFilePicker\"><code>Window.showSaveFilePicker()</code></a></li>\n  <li><a href=\"/en-US/docs/Web/API/Fullscreen_API\">Fullscreen API</a>: <a href=\"/en-US/docs/Web/API/Element/requestFullscreen\"><code>Element.requestFullscreen()</code></a></li>\n  <li><a href=\"/en-US/docs/Web/API/Idle_Detection_API\">Idle Detection API</a>: <a href=\"/en-US/docs/Web/API/IdleDetector/requestPermission_static\" title=\"IdleDetector.requestPermission()\"><code>IdleDetector.requestPermission()</code></a></li>\n  <li><a href=\"/en-US/docs/Web/API/Keyboard_API\">Keyboard API</a>: <a href=\"/en-US/docs/Web/API/Keyboard/lock\"><code>Keyboard.lock()</code></a> (which requires fullscreen)</li>\n  <li><a href=\"/en-US/docs/Web/API/Payment_Request_API\">Payment Request API</a>: <a href=\"/en-US/docs/Web/API/PaymentRequest/show\"><code>PaymentRequest.show()</code></a></li>\n  <li><a href=\"/en-US/docs/Web/API/Presentation_API\">Presentation API</a>: <a href=\"/en-US/docs/Web/API/PresentationRequest/start\"><code>PresentationRequest.start()</code></a></li>\n  <li><a href=\"/en-US/docs/Web/API/Pointer_Lock_API\">Pointer Lock API</a>: <a href=\"/en-US/docs/Web/API/Element/requestPointerLock\"><code>Element.requestPointerLock()</code></a></li>\n  <li><a href=\"/en-US/docs/Web/API/Screen_Capture_API\">Screen Capture API</a>: <a href=\"/en-US/docs/Web/API/MediaDevices/getDisplayMedia\"><code>MediaDevices.getDisplayMedia()</code></a></li>\n  <li><a href=\"/en-US/docs/Web/API/Web_Share_API\">Web Share API</a>: <a href=\"/en-US/docs/Web/API/Navigator/share\"><code>Navigator.share()</code></a></li>\n  <li><a href=\"/en-US/docs/Web/API/Window/open\"><code>Window.open()</code></a></li>\n</ul>\n<p>APIs that require the containing document to be focused:</p>\n<ul>\n  <li><a href=\"/en-US/docs/Web/API/Clipboard_API\">Clipboard API</a>: <a href=\"/en-US/docs/Web/API/Clipboard/read\"><code>Clipboard.read()</code></a>, <a href=\"/en-US/docs/Web/API/Clipboard/readText\"><code>Clipboard.readText()</code></a>, <a href=\"/en-US/docs/Web/API/Clipboard/write\"><code>Clipboard.write()</code></a>, <a href=\"/en-US/docs/Web/API/Clipboard/writeText\"><code>Clipboard.writeText()</code></a></li>\n</ul>\n<p>APIs that require the containing document's <a href=\"/en-US/docs/Web/API/Document/visibilityState\"><code>Document.visibilityState</code></a> to be <code>\"visible\"</code>:</p>\n<ul>\n  <li><a href=\"/en-US/docs/Web/API/Picture-in-Picture_API\">Picture-in-Picture API</a>: <a href=\"/en-US/docs/Web/API/HTMLVideoElement/requestPictureInPicture\"><code>HTMLVideoElement.requestPictureInPicture()</code></a> (requires the containing document's visibility state to be `\"visible\", <em>or</em> <a href=\"/en-US/docs/Glossary/Transient_activation\">transient activation</a>)</li>\n  <li><a href=\"/en-US/docs/Web/API/Screen_Wake_Lock_API\">Screen Wake Lock API</a>: <a href=\"/en-US/docs/Web/API/WakeLock/request\"><code>WakeLock.request()</code></a></li>\n</ul>"}},{"type":"prose","value":{"id":"other_restricted_features","title":"Other restricted features","isH3":true,"content":"<ul>\n  <li>Download links, i.e. <a href=\"/en-US/docs/Web/HTML/Element/a\"><code>&lt;a&gt;</code></a> and <a href=\"/en-US/docs/Web/HTML/Element/area\"><code>&lt;area&gt;</code></a> elements with the <code>download</code> attribute, will have their downloads delayed until prerendering has finished.</li>\n  <li>No cross-site navigations: Any prerendering document that navigates to a different site will be immediately discarded before a request to that other site is sent.</li>\n  <li>Restricted URLs: Prerendering documents cannot host non-HTTP(S) top-level URLs. Including the following URL types will cause the prerender to be immediately discarded:\n    <ul>\n      <li><code>javascript:</code> URLs</li>\n      <li><code>data:</code> URLs</li>\n      <li><code>blob:</code> URLs</li>\n      <li><code>about:</code> URLs, including <code>about:blank</code> and <code>about:srcdoc</code></li>\n    </ul>\n  </li>\n  <li>Session storage: <a href=\"/en-US/docs/Web/API/Window/sessionStorage\"><code>Window.sessionStorage</code></a> can be used, but the behavior is very specific, to avoid breaking sites that expect only one page to access the tab's session storage at a time. A prerendered page therefore starts out with a clone of the tab's session storage state from when it was created. Upon activation, the prerendered page's storage clone is discarded, and the tab's main storage state is used instead. Pages that use session storage can use the <a href=\"/en-US/docs/Web/API/Document/prerenderingchange_event\" title=\"prerenderingchange\"><code>prerenderingchange</code></a> event to detect when this storage swap occurs.</li>\n  <li><a href=\"/en-US/docs/Web/API/Window/print\"><code>Window.print()</code></a>: Any calls to this method are ignored.</li>\n  <li>\"Simple dialog methods\" are restricted as follows:\n    <ul>\n      <li><a href=\"/en-US/docs/Web/API/Window/alert\"><code>Window.alert()</code></a> immediately returns without showing a dialog.</li>\n      <li><a href=\"/en-US/docs/Web/API/Window/confirm\"><code>Window.confirm()</code></a> immediately returns <code>false</code> without showing a dialog.</li>\n      <li><a href=\"/en-US/docs/Web/API/Window/prompt\"><code>Window.prompt()</code></a> immediately returns an empty string (<code>\"\"</code>) without showing a dialog.</li>\n    </ul>\n  </li>\n  <li>Dedicated/shared worker scripts are loaded, but their execution is deferred until the prerendered document is activated.</li>\n  <li>Cross-origin <a href=\"/en-US/docs/Web/HTML/Element/iframe\"><code>&lt;iframe&gt;</code></a> loads are delayed while prerendering until after the page is activated.</li>\n</ul>"}},{"type":"prose","value":{"id":"interfaces","title":"Interfaces","isH3":false,"content":"<p>The Speculation Rules API does not define any interfaces of its own.</p>"}},{"type":"prose","value":{"id":"extensions_to_other_interfaces","title":"Extensions to other interfaces","isH3":true,"content":"<dl>\n  <dt id=\"document.prerendering\"><a href=\"/en-US/docs/Web/API/Document/prerendering\"><code>Document.prerendering</code></a></dt>\n  <dd>\n    <p>A boolean property that returns <code>true</code> if the document is currently in the process of prerendering.</p>\n  </dd>\n  <dt id=\"prerenderingchange\"><a href=\"/en-US/docs/Web/API/Document/prerenderingchange_event\" title=\"prerenderingchange\"><code>prerenderingchange</code></a> event</dt>\n  <dd>\n    <p>Fired on a prerendered document when it is activated (i.e. the user views the page).</p>\n  </dd>\n  <dt id=\"performancenavigationtiming.activationstart\"><a href=\"/en-US/docs/Web/API/PerformanceNavigationTiming/activationStart\"><code>PerformanceNavigationTiming.activationStart</code></a></dt>\n  <dd>\n    <p>A number representing the time between when a document starts prerendering and when it is activated.</p>\n  </dd>\n  <dt id=\"performanceresourcetiming.deliverytype\"><a href=\"/en-US/docs/Web/API/PerformanceResourceTiming/deliveryType\"><code>PerformanceResourceTiming.deliveryType</code></a>, <code>\"navigational-prefetch\"</code> value</dt>\n  <dd>\n    <p>Signals that the type of a performance entry is a prefetch.</p>\n  </dd>\n</dl>"}},{"type":"prose","value":{"id":"http_headers","title":"HTTP headers","isH3":false,"content":"<dl>\n  <dt id=\"content-security-policy\"><a href=\"/en-US/docs/Web/HTTP/Headers/Content-Security-Policy\"><code>Content-Security-Policy</code></a> <code>'inline-speculation-rules'</code> value</dt>\n  <dd>\n    <p>Used to opt-in to allowing usage of <code>&lt;script type=\"speculationrules\"&gt;</code> to define speculation rules on the document being fetched.</p>\n  </dd>\n  <dt id=\"supports-loading-mode\"><a href=\"/en-US/docs/Web/HTTP/Headers/Supports-Loading-Mode\"><code>Supports-Loading-Mode</code></a></dt>\n  <dd>\n    <p>Set by a navigation target to opt-in to using various higher-risk loading modes. For example, cross-origin, same-site prerendering requires a <code>Supports-Loading-Mode</code> value of <code>credentialed-prerender</code>.</p>\n  </dd>\n</dl>"}},{"type":"prose","value":{"id":"html_features","title":"HTML features","isH3":false,"content":"<dl>\n  <dt id=\"script_typespeculationrules_..._script\"><a href=\"/en-US/docs/Web/HTML/Element/script/type/speculationrules\"><code>&lt;script type=\"speculationrules\"&gt; ... &lt;/script&gt;</code></a></dt>\n  <dd>\n    <p>Used to define a set of prefetch and/or prerender speculation rules on the current document.</p>\n  </dd>\n</dl>"}},{"type":"prose","value":{"id":"examples","title":"Examples","isH3":false,"content":"<p>You can find a <a href=\"https://prerender-demos.glitch.me/\" class=\"external\" target=\"_blank\">complete prerender demo here</a>.</p>"}},{"type":"specifications","value":{"title":"Specifications","id":"specifications","isH3":false,"specifications":[{"bcdSpecificationURL":"https://wicg.github.io/nav-speculation/speculation-rules.html#speculation-rules-script","title":"Speculation Rules"}],"query":"html.elements.script.type.speculationrules"}},{"type":"browser_compatibility","value":{"title":"Browser compatibility","id":"browser_compatibility","isH3":false,"query":"html.elements.script.type.speculationrules"}},{"type":"prose","value":{"id":"see_also","title":"See also","isH3":false,"content":"<ul>\n  <li><a href=\"https://developer.chrome.com/blog/prerender-pages/\" class=\"external\" target=\"_blank\">Prerender pages in Chrome for instant page navigations</a> on developer.chrome.com (2023)</li>\n  <li><a href=\"/en-US/docs/Web/Performance/Speculative_loading\">Speculative loading</a> for a comparison of speculation rules and other similar performance improvement features.</li>\n</ul>"}}],"toc":[{"text":"Concepts and usage","id":"concepts_and_usage"},{"text":"Detecting prefetched and prerendered pages","id":"detecting_prefetched_and_prerendered_pages"},{"text":"Unsafe speculative loading conditions","id":"unsafe_speculative_loading_conditions"},{"text":"Session history behavior for prerendered documents","id":"session_history_behavior_for_prerendered_documents"},{"text":"Platform features deferred or restricted during prerender","id":"platform_features_deferred_or_restricted_during_prerender"},{"text":"Interfaces","id":"interfaces"},{"text":"HTTP headers","id":"http_headers"},{"text":"HTML features","id":"html_features"},{"text":"Examples","id":"examples"},{"text":"Specifications","id":"specifications"},{"text":"Browser compatibility","id":"browser_compatibility"},{"text":"See also","id":"see_also"}],"summary":"The Speculation Rules API is designed to improve performance for future navigations. It targets document URLs rather than specific resource files, and so makes sense for multi-page applications (MPAs) rather than single-page applications (SPAs).","popularity":0.0051,"modified":"2023-11-25T17:49:10.000Z","source":{"folder":"en-us/web/api/speculation_rules_api","github_url":"https://github.com/mdn/content/blob/main/files/en-us/web/api/speculation_rules_api/index.md","last_commit_url":"https://github.com/mdn/content/commit/a9a244544c97235c6433803f535f0350b925653d","filename":"index.md"},"short_title":"Speculation Rules API","parents":[{"uri":"/en-US/docs/Web","title":"References"},{"uri":"/en-US/docs/Web/API","title":"Web APIs"},{"uri":"/en-US/docs/Web/API/Speculation_Rules_API","title":"Speculation Rules API"}],"pageTitle":"Speculation Rules API - Web APIs | MDN","noIndexing":false}}