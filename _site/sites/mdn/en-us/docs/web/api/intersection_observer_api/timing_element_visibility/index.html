<!doctype html><html lang="en-US" prefix="og: https://ogp.me/ns#"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><link rel="icon" href="/favicon-48x48.cbbd161b.png"/><link rel="apple-touch-icon" href="/apple-touch-icon.6803c6f0.png"/><meta name="theme-color" content="#ffffff"/><link rel="manifest" href="/manifest.56b1cedc.json"/><link rel="search" type="application/opensearchdescription+xml" href="/opensearch.xml" title="MDN Web Docs"/><title>Timing element visibility with the Intersection Observer API - Web APIs | MDN</title><link rel="alternate" type="application/rss+xml" title="MDN Blog RSS Feed" href="https://developer.mozilla.org/en-US/blog/rss.xml" hreflang="en" /><meta name="robots" content="noindex, nofollow"><meta name="description" content="In this article, we&apos;ll build a mock blog which has a number of ads interspersed among the contents of the page, then use the Intersection Observer API to track how much time each ad is visible to the user. When an ad exceeds one minute of visible time, it will be replaced with a new one."/><meta property="og:url" content="https://developer.mozilla.org/en-US/docs/Web/API/Intersection_Observer_API/Timing_element_visibility"/><meta property="og:title" content="Timing element visibility with the Intersection Observer API - Web APIs | MDN"/><meta property="og:type" content="website"/><meta property="og:locale" content="en_US"/><meta property="og:description" content="In this article, we&apos;ll build a mock blog which has a number of ads interspersed among the contents of the page, then use the Intersection Observer API to track how much time each ad is visible to the user. When an ad exceeds one minute of visible time, it will be replaced with a new one."/><meta property="og:image" content="https://developer.mozilla.org/mdn-social-share.cd6c4a5a.png"/><meta property="og:image:type" content="image/png"/><meta property="og:image:height" content="1080"/><meta property="og:image:width" content="1920"/><meta property="og:image:alt" content="The MDN Web Docs logo, featuring a blue accent color, displayed on a solid black background."/><meta property="og:site_name" content="MDN Web Docs"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:creator" content="MozDevNet"/><link rel="canonical" href="https://developer.mozilla.org/en-US/docs/Web/API/Intersection_Observer_API/Timing_element_visibility"/><style media="print">.article-actions-container,.document-toc-container,.language-menu,.main-menu-toggle,.on-github,.page-footer,.place,.sidebar,.top-banner,.top-navigation-main,ul.prev-next{display:none!important}.main-page-content,.main-page-content pre{padding:2px}.main-page-content pre{border-left-width:2px}</style><script defer="defer" src="/static/js/main.8204838d.js"></script><link href="/static/css/main.3551aa81.css" rel="stylesheet"></head><body><script>if(document.body.addEventListener("load",(t=>{t.target.classList.contains("interactive")&&t.target.setAttribute("data-readystate","complete")}),{capture:!0}),window&&document.documentElement){const t={light:"#ffffff",dark:"#1b1b1b"};try{const e=window.localStorage.getItem("theme");e&&(document.documentElement.className=e,document.documentElement.style.backgroundColor=t[e])}catch(t){console.warn("Unable to read theme from localStorage",t)}}</script><div id="root"><ul id="nav-access" class="a11y-nav"><li><a id="skip-main" href="#content">Skip to main content</a></li><li><a id="skip-search" href="#top-nav-search-input">Skip to search</a></li><li><a id="skip-select-language" href="#languages-switcher-button">Skip to select language</a></li></ul><div class="page-wrapper  category-api document-page"><div class="top-banner loading"><section class="place top container"></section></div><div class="sticky-header-container"><header class="top-navigation 
      
      "><div class="container "><div class="top-navigation-wrap"><a href="/en-US/" class="logo" aria-label="MDN homepage"><svg id="mdn-docs-logo" xmlns="http://www.w3.org/2000/svg" x="0" y="0" viewBox="0 0 694.9 104.4" style="enable-background:new 0 0 694.9 104.4" xml:space="preserve" role="img"><title>MDN Web Docs</title><path d="M40.3 0 11.7 92.1H0L28.5 0h11.8zm10.4 0v92.1H40.3V0h10.4zM91 0 62.5 92.1H50.8L79.3 0H91zm10.4 0v92.1H91V0h10.4z" class="logo-m"></path><path d="M627.9 95.6h67v8.8h-67v-8.8z" class="logo-_"></path><path d="M367 42h-4l-10.7 30.8h-5.5l-10.8-26h-.4l-10.5 26h-5.2L308.7 42h-3.8v-5.6H323V42h-6.5l6.8 20.4h.4l10.3-26h4.7l11.2 26h.5l5.7-20.3h-6.2v-5.6H367V42zm34.9 20c-.4 3.2-2 5.9-4.7 8.2-2.8 2.3-6.5 3.4-11.3 3.4-5.4 0-9.7-1.6-13.1-4.7-3.3-3.2-5-7.7-5-13.7 0-5.7 1.6-10.3 4.7-14s7.4-5.5 12.9-5.5c5.1 0 9.1 1.6 11.9 4.7s4.3 6.9 4.3 11.3c0 1.5-.2 3-.5 4.7h-25.6c.3 7.7 4 11.6 10.9 11.6 2.9 0 5.1-.7 6.5-2 1.5-1.4 2.5-3 3-4.9l6 .9zM394 51.3c.2-2.4-.4-4.7-1.8-6.9s-3.8-3.3-7-3.3c-3.1 0-5.3 1-6.9 3-1.5 2-2.5 4.4-2.8 7.2H394zm51 2.4c0 5-1.3 9.5-4 13.7s-6.9 6.2-12.7 6.2c-6 0-10.3-2.2-12.7-6.7-.1.4-.2 1.4-.4 2.9s-.3 2.5-.4 2.9h-7.3c.3-1.7.6-3.5.8-5.3.3-1.8.4-3.7.4-5.5V22.3h-6v-5.6H416v27c1.1-2.2 2.7-4.1 4.7-5.7 2-1.6 4.8-2.4 8.4-2.4 4.6 0 8.4 1.6 11.4 4.7 3 3.2 4.5 7.6 4.5 13.4zm-7.7.6c0-4.2-1-7.4-3-9.5-2-2.2-4.4-3.3-7.4-3.3-3.4 0-6 1.2-8 3.7-1.9 2.4-2.9 5-3 7.7V57c0 3 1 5.6 3 7.7s4.5 3.1 7.6 3.1c3.6 0 6.3-1.3 8.1-3.9 1.8-2.7 2.7-5.9 2.7-9.6zm69.2 18.5h-13.2v-7.2c-1.2 2.2-2.8 4.1-4.9 5.6-2.1 1.6-4.8 2.4-8.3 2.4-4.8 0-8.7-1.6-11.6-4.9-2.9-3.2-4.3-7.7-4.3-13.3 0-5 1.3-9.6 4-13.7 2.6-4.1 6.9-6.2 12.8-6.2 5.7 0 9.8 2.2 12.3 6.5V22.3h-8.6v-5.6h15.8v50.6h6v5.5zM493.2 56v-4.4c-.1-3-1.2-5.5-3.2-7.3s-4.4-2.8-7.2-2.8c-3.6 0-6.3 1.3-8.2 3.9-1.9 2.6-2.8 5.8-2.8 9.6 0 4.1 1 7.3 3 9.5s4.5 3.3 7.4 3.3c3.2 0 5.8-1.3 7.8-3.8 2.1-2.6 3.1-5.3 3.2-8zm53.1-1.4c0 5.6-1.8 10.2-5.3 13.7s-8.2 5.3-13.9 5.3-10.1-1.7-13.4-5.1c-3.3-3.4-5-7.9-5-13.5 0-5.3 1.6-9.9 4.7-13.7 3.2-3.8 7.9-5.7 14.2-5.7s11 1.9 14.1 5.7c3 3.7 4.6 8.1 4.6 13.3zm-7.7-.2c0-4-1-7.2-3-9.5s-4.8-3.5-8.2-3.5c-3.6 0-6.4 1.2-8.3 3.7s-2.9 5.6-2.9 9.5c0 3.7.9 6.8 2.8 9.4 1.9 2.6 4.6 3.9 8.3 3.9 3.6 0 6.4-1.3 8.4-3.8 1.9-2.6 2.9-5.8 2.9-9.7zm45 5.8c-.4 3.2-1.9 6.3-4.4 9.1-2.5 2.9-6.4 4.3-11.8 4.3-5.2 0-9.4-1.6-12.6-4.8-3.2-3.2-4.8-7.7-4.8-13.7 0-5.5 1.6-10.1 4.7-13.9 3.2-3.8 7.6-5.7 13.2-5.7 2.3 0 4.6.3 6.7.8 2.2.5 4.2 1.5 6.2 2.9l1.5 9.5-5.9.7-1.3-6.1c-2.1-1.2-4.5-1.8-7.2-1.8-3.5 0-6.1 1.2-7.7 3.7-1.7 2.5-2.5 5.7-2.5 9.6 0 4.1.9 7.3 2.7 9.5 1.8 2.3 4.4 3.4 7.8 3.4 5.2 0 8.2-2.9 9.2-8.8l6.2 1.3zm34.7 1.9c0 3.6-1.5 6.5-4.6 8.5s-7 3-11.7 3c-5.7 0-10.6-1.2-14.6-3.6l1.2-8.8 5.7.6-.2 4.7c1.1.5 2.3.9 3.6 1.1s2.6.3 3.9.3c2.4 0 4.5-.4 6.5-1.3 1.9-.9 2.9-2.2 2.9-4.1 0-1.8-.8-3.1-2.3-3.8s-3.5-1.3-5.8-1.7-4.6-.9-6.9-1.4c-2.3-.6-4.2-1.6-5.7-2.9-1.6-1.4-2.3-3.5-2.3-6.3 0-4.1 1.5-6.9 4.6-8.5s6.4-2.4 9.9-2.4c2.6 0 5 .3 7.2.9 2.2.6 4.3 1.4 6.1 2.4l.8 8.8-5.8.7-.8-5.7c-2.3-1-4.7-1.6-7.2-1.6-2.1 0-3.7.4-5.1 1.1-1.3.8-2 2-2 3.8 0 1.7.8 2.9 2.3 3.6 1.5.7 3.4 1.2 5.7 1.6 2.2.4 4.5.8 6.7 1.4 2.2.6 4.1 1.6 5.7 3 1.4 1.6 2.2 3.7 2.2 6.6zM197.6 73.2h-17.1v-5.5h3.8V51.9c0-3.7-.7-6.3-2.1-7.9-1.4-1.6-3.3-2.3-5.7-2.3-3.2 0-5.6 1.1-7.2 3.4s-2.4 4.6-2.5 6.9v15.6h6v5.5h-17.1v-5.5h3.8V51.9c0-3.8-.7-6.4-2.1-7.9-1.4-1.5-3.3-2.3-5.6-2.3-3.2 0-5.5 1.1-7.2 3.3-1.6 2.2-2.4 4.5-2.5 6.9v15.8h6.9v5.5h-20.2v-5.5h6V42.4h-6.1v-5.6h13.4v6.4c1.2-2.1 2.7-3.8 4.7-5.2 2-1.3 4.4-2 7.3-2s5.3.7 7.5 2.1c2.2 1.4 3.7 3.5 4.5 6.4 1.1-2.5 2.7-4.5 4.9-6.1s4.8-2.4 7.9-2.4c3.5 0 6.5 1.1 8.9 3.3s3.7 5.6 3.7 10.2v18.2h6.1v5.5zm42.5 0h-13.2V66c-1.2 2.2-2.8 4.1-4.9 5.6-2.1 1.6-4.8 2.4-8.3 2.4-4.8 0-8.7-1.6-11.6-4.9-2.9-3.2-4.3-7.7-4.3-13.3 0-5 1.3-9.6 4-13.7 2.6-4.1 6.9-6.2 12.8-6.2s9.8 2.2 12.3 6.5V22.7h-8.6v-5.6h15.8v50.6h6v5.5zm-13.3-16.8V52c-.1-3-1.2-5.5-3.2-7.3s-4.4-2.8-7.2-2.8c-3.6 0-6.3 1.3-8.2 3.9-1.9 2.6-2.8 5.8-2.8 9.6 0 4.1 1 7.3 3 9.5s4.5 3.3 7.4 3.3c3.2 0 5.8-1.3 7.8-3.8 2.1-2.6 3.1-5.3 3.2-8zm61.5 16.8H269v-5.5h6V51.9c0-3.7-.7-6.3-2.2-7.9-1.4-1.6-3.4-2.3-5.7-2.3-3.1 0-5.6 1-7.4 3s-2.8 4.4-2.9 7v15.9h6v5.5h-19.3v-5.5h6V42.4h-6.2v-5.6h13.6V43c2.6-4.6 6.8-6.9 12.7-6.9 3.6 0 6.7 1.1 9.2 3.3s3.7 5.6 3.7 10.2v18.2h6v5.4h-.2z" class="logo-text"></path></svg></a><button title="Open main menu" type="button" class="button action has-icon main-menu-toggle" aria-haspopup="menu" aria-label="Open main menu" aria-expanded="false"><span class="button-wrap"><span class="icon icon-menu "></span><span class="visually-hidden">Open main menu</span></span></button></div><div class="top-navigation-main"><nav class="main-nav" aria-label="Main menu"><ul class="main-menu nojs"><li class="top-level-entry-container active"><button type="button" id="references-button" class="top-level-entry menu-toggle" aria-controls="references-menu" aria-expanded="false">References</button><a href="/en-US/docs/Web" class="top-level-entry">References</a><ul id="references-menu" class="submenu references hidden inline-submenu-lg" aria-labelledby="references-button"><li class="apis-link-container mobile-only "><a href="/en-US/docs/Web" class="submenu-item "><div class="submenu-icon"></div><div class="submenu-content-container"><div class="submenu-item-heading">Overview / Web Technology</div><p class="submenu-item-description">Web technology reference for developers</p></div></a></li><li class="html-link-container "><a href="/en-US/docs/Web/HTML" class="submenu-item "><div class="submenu-icon html"></div><div class="submenu-content-container"><div class="submenu-item-heading">HTML</div><p class="submenu-item-description">Structure of content on the web</p></div></a></li><li class="css-link-container "><a href="/en-US/docs/Web/CSS" class="submenu-item "><div class="submenu-icon css"></div><div class="submenu-content-container"><div class="submenu-item-heading">CSS</div><p class="submenu-item-description">Code used to describe document style</p></div></a></li><li class="javascript-link-container "><a href="/en-US/docs/Web/JavaScript" class="submenu-item "><div class="submenu-icon javascript"></div><div class="submenu-content-container"><div class="submenu-item-heading">JavaScript</div><p class="submenu-item-description">General-purpose scripting language</p></div></a></li><li class="http-link-container "><a href="/en-US/docs/Web/HTTP" class="submenu-item "><div class="submenu-icon http"></div><div class="submenu-content-container"><div class="submenu-item-heading">HTTP</div><p class="submenu-item-description">Protocol for transmitting web resources</p></div></a></li><li class="apis-link-container "><a href="/en-US/docs/Web/API" class="submenu-item "><div class="submenu-icon apis"></div><div class="submenu-content-container"><div class="submenu-item-heading">Web APIs</div><p class="submenu-item-description">Interfaces for building web applications</p></div></a></li><li class="apis-link-container "><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions" class="submenu-item "><div class="submenu-icon"></div><div class="submenu-content-container"><div class="submenu-item-heading">Web Extensions</div><p class="submenu-item-description">Developing extensions for web browsers</p></div></a></li><li class="apis-link-container desktop-only "><a href="/en-US/docs/Web" class="submenu-item "><div class="submenu-icon"></div><div class="submenu-content-container"><div class="submenu-item-heading">Web Technology</div><p class="submenu-item-description">Web technology reference for developers</p></div></a></li></ul></li><li class="top-level-entry-container "><button type="button" id="guides-button" class="top-level-entry menu-toggle" aria-controls="guides-menu" aria-expanded="false">Guides</button><a href="/en-US/docs/Learn" class="top-level-entry">Guides</a><ul id="guides-menu" class="submenu guides hidden inline-submenu-lg" aria-labelledby="guides-button"><li class="apis-link-container mobile-only "><a href="/en-US/docs/Learn" class="submenu-item "><div class="submenu-icon learn"></div><div class="submenu-content-container"><div class="submenu-item-heading">Overview / MDN Learning Area</div><p class="submenu-item-description">Learn web development</p></div></a></li><li class="apis-link-container desktop-only "><a href="/en-US/docs/Learn" class="submenu-item "><div class="submenu-icon learn"></div><div class="submenu-content-container"><div class="submenu-item-heading">MDN Learning Area</div><p class="submenu-item-description">Learn web development</p></div></a></li><li class="html-link-container "><a href="/en-US/docs/Learn/HTML" class="submenu-item "><div class="submenu-icon html"></div><div class="submenu-content-container"><div class="submenu-item-heading">HTML</div><p class="submenu-item-description">Learn to structure web content with HTML</p></div></a></li><li class="css-link-container "><a href="/en-US/docs/Learn/CSS" class="submenu-item "><div class="submenu-icon css"></div><div class="submenu-content-container"><div class="submenu-item-heading">CSS</div><p class="submenu-item-description">Learn to style content using CSS</p></div></a></li><li class="javascript-link-container "><a href="/en-US/docs/Learn/JavaScript" class="submenu-item "><div class="submenu-icon javascript"></div><div class="submenu-content-container"><div class="submenu-item-heading">JavaScript</div><p class="submenu-item-description">Learn to run scripts in the browser</p></div></a></li><li class=" "><a href="/en-US/docs/Web/Accessibility" class="submenu-item "><div class="submenu-icon"></div><div class="submenu-content-container"><div class="submenu-item-heading">Accessibility</div><p class="submenu-item-description">Learn to make the web accessible to all</p></div></a></li></ul></li><li class="top-level-entry-container "><a class="top-level-entry menu-link" href="/en-US/blog/">Blog</a></li><li class="top-level-entry-container "><a class="top-level-entry menu-link" href="/en-US/play">Play</a></li><li class="top-level-entry-container "><a class="top-level-entry menu-link" href="/en-US/plus/ai-help">AI Help <sup class="new beta">Beta</sup></a></li></ul></nav><div class="header-search"><form action="/en-US/search" class="search-form search-widget" id="top-nav-search-form" role="search"><label id="top-nav-search-label" for="top-nav-search-input" class="visually-hidden">Search MDN</label><input aria-activedescendant="" aria-autocomplete="list" aria-controls="top-nav-search-menu" aria-expanded="false" aria-labelledby="top-nav-search-label" autoComplete="off" id="top-nav-search-input" role="combobox" type="search" class="search-input-field" name="q" placeholder="   " required="" value=""/><button type="button" class="button action has-icon clear-search-button"><span class="button-wrap"><span class="icon icon-cancel "></span><span class="visually-hidden">Clear search input</span></span></button><button type="submit" class="button action has-icon search-button"><span class="button-wrap"><span class="icon icon-search "></span><span class="visually-hidden">Search</span></span></button><div id="top-nav-search-menu" role="listbox" aria-labelledby="top-nav-search-label"></div></form></div><div class="theme-switcher-menu"><button type="button" class="button action has-icon theme-switcher-menu small" aria-haspopup="menu"><span class="button-wrap"><span class="icon icon-theme-os-default "></span>Theme</span></button></div><ul class="auth-container"><li><a href="?next=%2Fen-US%2Fdocs%2FWeb%2FAPI%2FIntersection_Observer_API%2FTiming_element_visibility" class="login-link" rel="nofollow">Log in</a></li><li><a href="?next=%2Fen-US%2Fdocs%2FWeb%2FAPI%2FIntersection_Observer_API%2FTiming_element_visibility" target="_self" class="button primary mdn-plus-subscribe-link"><span class="button-wrap">Sign up for free</span></a></li></ul></div></div></header><div class="article-actions-container"><div class="container"><button type="button" class="button action has-icon sidebar-button" aria-label="Expand sidebar" aria-expanded="false" aria-controls="sidebar-quicklinks"><span class="button-wrap"><span class="icon icon-sidebar "></span></span></button><nav class="breadcrumbs-container" aria-label="Breadcrumb"><ol typeof="BreadcrumbList" vocab="https://schema.org/" aria-label="breadcrumbs"><li property="itemListElement" typeof="ListItem"><a class="breadcrumb" property="item" typeof="WebPage" href="/en-US/docs/Web"><span property="name">References</span></a><meta property="position" content="1"/></li><li property="itemListElement" typeof="ListItem"><a class="breadcrumb" property="item" typeof="WebPage" href="/en-US/docs/Web/API"><span property="name">Web APIs</span></a><meta property="position" content="2"/></li><li property="itemListElement" typeof="ListItem"><a class="breadcrumb" property="item" typeof="WebPage" href="/en-US/docs/Web/API/Intersection_Observer_API"><span property="name">Intersection Observer API</span></a><meta property="position" content="3"/></li><li property="itemListElement" typeof="ListItem"><a class="breadcrumb-current-page" property="item" typeof="WebPage" href="/en-US/docs/Web/API/Intersection_Observer_API/Timing_element_visibility"><span property="name">Timing element visibility with the Intersection Observer API</span></a><meta property="position" content="4"/></li></ol></nav></div></div></div><div class="main-wrapper"><div class="sidebar-container"><aside id="sidebar-quicklinks" class="sidebar" data-macro="DefaultAPISidebar"><button type="button" class="button action backdrop" aria-label="Collapse sidebar"><span class="button-wrap"></span></button><nav aria-label="Related Topics" class="sidebar-inner"><header class="sidebar-actions"><section class="sidebar-filter-container"><div class="sidebar-filter "><label id="sidebar-filter-label" class="sidebar-filter-label" for="sidebar-filter-input"><span class="icon icon-filter"></span><span class="visually-hidden">Filter sidebar</span></label><input id="sidebar-filter-input" autoComplete="off" class="sidebar-filter-input-field false" type="text" placeholder="Filter" value=""/><button type="button" class="button action has-icon clear-sidebar-filter-button"><span class="button-wrap"><span class="icon icon-cancel "></span><span class="visually-hidden">Clear filter input</span></span></button></div></section></header><div class="sidebar-inner-nav"><div class="in-nav-toc"><div class="document-toc-container"><section class="document-toc"><header><h2 class="document-toc-heading">In this article</h2></header><ul class="document-toc-list"><li class="document-toc-item "><a class="document-toc-link" href="#building_the_site">Building the site</a></li><li class="document-toc-item "><a class="document-toc-link" href="#see_also">See also</a></li></ul></section></div></div><div class="sidebar-body"><ol><li><strong><a href="/en-US/docs/Web/API/Intersection_Observer_API">Intersection Observer API</a></strong></li><li class="toggle"><details open=""><summary>Guides</summary><ol><li><em><a href="/en-US/docs/Web/API/Intersection_Observer_API/Timing_element_visibility" aria-current="page">Timing element visibility with the Intersection Observer API</a></em></li></ol></details></li><li class="toggle"><details open=""><summary>Interfaces</summary><ol><li><a href="/en-US/docs/Web/API/IntersectionObserver"><code>IntersectionObserver</code></a></li><li><a href="/en-US/docs/Web/API/IntersectionObserverEntry"><code>IntersectionObserverEntry</code></a></li></ol></details></li></ol></div></div></nav></aside><div class="toc-container"><aside class="toc"><nav><div class="document-toc-container"><section class="document-toc"><header><h2 class="document-toc-heading">In this article</h2></header><ul class="document-toc-list"><li class="document-toc-item "><a class="document-toc-link" href="#building_the_site">Building the site</a></li><li class="document-toc-item "><a class="document-toc-link" href="#see_also">See also</a></li></ul></section></div></nav></aside></div></div><main id="content" class="main-content  "><article class="main-page-content" lang="en-US"><header><h1>Timing element visibility with the Intersection Observer API</h1></header><div class="section-content"><p>In this article, we'll build a mock blog which has a number of ads interspersed among the contents of the page, then use the <a href="/en-US/docs/Web/API/Intersection_Observer_API">Intersection Observer API</a> to track how much time each ad is visible to the user. When an ad exceeds one minute of visible time, it will be replaced with a new one.</p>
<p>Although many aspects of this example will not match real-world usage (in particular, the articles all have the same text and aren't loaded from a database, and there are just a handful of simple text-only ads that are selected from an array), this should provide enough understanding of the API to quickly learn how to apply the Intersection Observer API to your own site.</p>
<p>There's a good reason why the notion of tracking visibility of ads is being used in this example. It turns out that one of the most common uses of Flash or other script in advertising on the Web is to record how long each ad is visible, for the purpose of billing and payment of revenues. Without the Intersection Observer API, this winds up being done using intervals and timeouts for each individual ad, or other techniques that tend to slow the page down. Using this API lets everything get streamlined by the browser to reduce the impact on performance substantially.</p>
<p>Let's get started!</p></div><section aria-labelledby="building_the_site"><h2 id="building_the_site"><a href="#building_the_site">Building the site</a></h2><div class="section-content"></div></section><section aria-labelledby="site_structure_the_html"><h3 id="site_structure_the_html"><a href="#site_structure_the_html">Site structure: The HTML</a></h3><div class="section-content"><p>The site's structure is not too complicated. We'll be using <a href="/en-US/docs/Web/CSS/CSS_grid_layout">CSS Grid</a> to style and lay out the site, so we can be pretty straightforward here:</p>
<div class="code-example"><p class="example-header"><span class="language-name">html</span></p><pre class="brush: html notranslate"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>wrapper<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>header</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>A Fake Blog<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span><span class="token punctuation">&gt;</span></span>Showing Intersection Observer in action!<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>header</span><span class="token punctuation">&gt;</span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>aside</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>nav</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#link1<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>A link<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#link2<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>Another link<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#link3<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>One more link<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>nav</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>aside</span><span class="token punctuation">&gt;</span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>main</span><span class="token punctuation">&gt;</span></span>…<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>main</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre></div>
<p>This is the framework for the entire site. At the top is the site's header region, contained within a <a href="/en-US/docs/Web/HTML/Element/header"><code>&lt;header&gt;</code></a> block. Below that, we define the site's sidebar as a list of links within an <a href="/en-US/docs/Web/HTML/Element/aside"><code>&lt;aside&gt;</code></a> block.</p>
<p>Finally comes the main body. We start with an empty <a href="/en-US/docs/Web/HTML/Element/main"><code>&lt;main&gt;</code></a> element here. This box will be populated using script later.</p></div></section><section aria-labelledby="styling_the_site_with_css"><h3 id="styling_the_site_with_css"><a href="#styling_the_site_with_css">Styling the site with CSS</a></h3><div class="section-content"><p>With the structure of the site defined, we turn to the styling for the site. Let's look at the style for each component of the page individually.</p>
<h4 id="the_basics">The basics</h4>
<p>We provide styles for the <a href="/en-US/docs/Web/HTML/Element/body"><code>&lt;body&gt;</code></a> and <a href="/en-US/docs/Web/HTML/Element/main"><code>&lt;main&gt;</code></a> elements to define the site's background as well as the grid the various parts of the site will be placed in.</p>
<div class="code-example"><p class="example-header"><span class="language-name">css</span></p><pre class="brush: css notranslate"><code><span class="token selector">body</span> <span class="token punctuation">{</span>
  <span class="token property">font-family</span><span class="token punctuation">:</span> <span class="token string">"Open Sans"</span><span class="token punctuation">,</span> <span class="token string">"Arial"</span><span class="token punctuation">,</span> <span class="token string">"Helvetica"</span><span class="token punctuation">,</span> sans-serif<span class="token punctuation">;</span>
  <span class="token property">background-color</span><span class="token punctuation">:</span> aliceblue<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">.wrapper</span> <span class="token punctuation">{</span>
  <span class="token property">display</span><span class="token punctuation">:</span> grid<span class="token punctuation">;</span>
  <span class="token property">grid-template-columns</span><span class="token punctuation">:</span> auto <span class="token function">minmax</span><span class="token punctuation">(</span>min-content<span class="token punctuation">,</span> 1fr<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token property">grid-template-rows</span><span class="token punctuation">:</span> auto <span class="token function">minmax</span><span class="token punctuation">(</span>min-content<span class="token punctuation">,</span> 1fr<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token property">max-width</span><span class="token punctuation">:</span> 700px<span class="token punctuation">;</span>
  <span class="token property">margin</span><span class="token punctuation">:</span> 0 auto<span class="token punctuation">;</span>
  <span class="token property">background-color</span><span class="token punctuation">:</span> aliceblue<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p>The site's <a href="/en-US/docs/Web/HTML/Element/body"><code>&lt;body&gt;</code></a> is configured here to use one of a number of common sans-serif fonts, and to use <code>"aliceblue"</code> as the background color. Then the <code>"wrapper"</code> class is defined; it wraps the entire blog, including the header, sidebar, and body content (articles and ads).</p>
<p>The wrapper establishes a CSS grid with two columns and two rows. The first column (sized automatically based on its content) is used for the sidebar and the second column (which will be used for body content) is sized to be at least the width of the contents of the column and at most all remaining available space.</p>
<p>The first row will be used specially for the site header. The rows are sized the same way as the columns: the first one is automatically sized and the second one uses the remaining space, but at least enough space to provide room for all elements within it.</p>
<p>The wrapper's width is fixed at 700px so that it will fit in the available space when presented inline on MDN below.</p>
<h4 id="the_header">The header</h4>
<p>The header is fairly simple, since for this example all it contains is some text. Its style looks like this:</p>
<div class="code-example"><p class="example-header"><span class="language-name">css</span></p><pre class="brush: css notranslate"><code><span class="token selector">header</span> <span class="token punctuation">{</span>
  <span class="token property">grid-column</span><span class="token punctuation">:</span> 1 / -1<span class="token punctuation">;</span>
  <span class="token property">grid-row</span><span class="token punctuation">:</span> 1<span class="token punctuation">;</span>
  <span class="token property">background-color</span><span class="token punctuation">:</span> aliceblue<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p><a href="/en-US/docs/Web/CSS/grid-row"><code>grid-row</code></a> is set to 1, since we want the header to be placed in the top row of the site's grid. More interesting is our use of <a href="/en-US/docs/Web/CSS/grid-column"><code>grid-column</code></a> here; here we specify that we want the column to start in the first column and ends in the first column past the last grid line—in other words, the header spans across all of the columns within the grid. Perfect for our needs.</p>
<h4 id="the_sidebar">The sidebar</h4>
<p>Our sidebar is used to present links to other pages on the site. None of them work in our example here, but they exist to help with the presentation of a blog-like experience. The sidebar is represented using an <a href="/en-US/docs/Web/HTML/Element/aside"><code>&lt;aside&gt;</code></a> element, and is styled as follows:</p>
<div class="code-example"><p class="example-header"><span class="language-name">css</span></p><pre class="brush: css notranslate"><code><span class="token selector">aside</span> <span class="token punctuation">{</span>
  <span class="token property">grid-column</span><span class="token punctuation">:</span> 1<span class="token punctuation">;</span>
  <span class="token property">grid-row</span><span class="token punctuation">:</span> 2<span class="token punctuation">;</span>
  <span class="token property">background-color</span><span class="token punctuation">:</span> cornsilk<span class="token punctuation">;</span>
  <span class="token property">padding</span><span class="token punctuation">:</span> 5px 10px<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">aside ul</span> <span class="token punctuation">{</span>
  <span class="token property">padding-left</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">aside ul li</span> <span class="token punctuation">{</span>
  <span class="token property">list-style</span><span class="token punctuation">:</span> none<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">aside ul li a</span> <span class="token punctuation">{</span>
  <span class="token property">text-decoration</span><span class="token punctuation">:</span> none<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p>The most important thing to note here is that the <a href="/en-US/docs/Web/CSS/grid-column"><code>grid-column</code></a> is set to 1, to place the sidebar on the left-hand side of the screen. If you change this to -1, it will appear on the right (although some other elements will need some adjustments made to their margins to get the spacing just right). The <a href="/en-US/docs/Web/CSS/grid-row"><code>grid-row</code></a> is set to 2, to place it alongside the site body.</p>
<h4 id="the_content_body">The content body</h4>
<p>Speaking of the site's body: the main content of the site is kept in a <a href="/en-US/docs/Web/HTML/Element/main"><code>&lt;main&gt;</code></a> element. The following style is applied to that:</p>
<div class="code-example"><p class="example-header"><span class="language-name">css</span></p><pre class="brush: css notranslate"><code><span class="token selector">main</span> <span class="token punctuation">{</span>
  <span class="token property">grid-column</span><span class="token punctuation">:</span> 2<span class="token punctuation">;</span>
  <span class="token property">grid-row</span><span class="token punctuation">:</span> 2<span class="token punctuation">;</span>
  <span class="token property">margin</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>
  <span class="token property">margin-left</span><span class="token punctuation">:</span> 16px<span class="token punctuation">;</span>
  <span class="token property">font-size</span><span class="token punctuation">:</span> 16px<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p>The primary feature here is that the grid position is set to place the body content in column 2, row 2.</p>
<h4 id="articles">Articles</h4>
<p>Each article is contained in an <a href="/en-US/docs/Web/HTML/Element/article"><code>&lt;article&gt;</code></a> element, styled like this:</p>
<div class="code-example"><p class="example-header"><span class="language-name">css</span></p><pre class="brush: css notranslate"><code><span class="token selector">article</span> <span class="token punctuation">{</span>
  <span class="token property">background-color</span><span class="token punctuation">:</span> white<span class="token punctuation">;</span>
  <span class="token property">padding</span><span class="token punctuation">:</span> 6px<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">article:not(:last-child)</span> <span class="token punctuation">{</span>
  <span class="token property">margin-bottom</span><span class="token punctuation">:</span> 8px<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">article h2</span> <span class="token punctuation">{</span>
  <span class="token property">margin-top</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p>This creates article boxes with a white background which float atop the blue background, with a small margin around the article. Every article which isn't the last item in the container has an 8px bottom margin to space things apart.</p>
<h4 id="ads">Ads</h4>
<p>Finally, the ads have the following initial styling. Individual ads may customize the style somewhat, as we'll see later.</p>
<div class="code-example"><p class="example-header"><span class="language-name">css</span></p><pre class="brush: css notranslate"><code><span class="token selector">.ad</span> <span class="token punctuation">{</span>
  <span class="token property">height</span><span class="token punctuation">:</span> 96px<span class="token punctuation">;</span>
  <span class="token property">padding</span><span class="token punctuation">:</span> 6px<span class="token punctuation">;</span>
  <span class="token property">border-color</span><span class="token punctuation">:</span> #555<span class="token punctuation">;</span>
  <span class="token property">border-style</span><span class="token punctuation">:</span> solid<span class="token punctuation">;</span>
  <span class="token property">border-width</span><span class="token punctuation">:</span> 1px<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">.ad:not(:last-child)</span> <span class="token punctuation">{</span>
  <span class="token property">margin-bottom</span><span class="token punctuation">:</span> 8px<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">.ad h2</span> <span class="token punctuation">{</span>
  <span class="token property">margin-top</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">.ad div</span> <span class="token punctuation">{</span>
  <span class="token property">position</span><span class="token punctuation">:</span> relative<span class="token punctuation">;</span>
  <span class="token property">float</span><span class="token punctuation">:</span> right<span class="token punctuation">;</span>
  <span class="token property">padding</span><span class="token punctuation">:</span> 0 4px<span class="token punctuation">;</span>
  <span class="token property">height</span><span class="token punctuation">:</span> 20px<span class="token punctuation">;</span>
  <span class="token property">width</span><span class="token punctuation">:</span> 120px<span class="token punctuation">;</span>
  <span class="token property">font-size</span><span class="token punctuation">:</span> 14px<span class="token punctuation">;</span>
  <span class="token property">bottom</span><span class="token punctuation">:</span> 30px<span class="token punctuation">;</span>
  <span class="token property">border</span><span class="token punctuation">:</span> 1px solid black<span class="token punctuation">;</span>
  <span class="token property">background-color</span><span class="token punctuation">:</span> <span class="token function">rgba</span><span class="token punctuation">(</span>255<span class="token punctuation">,</span> 255<span class="token punctuation">,</span> 255<span class="token punctuation">,</span> 0.5<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p>There's nothing magic in here. It's fairly basic CSS.</p></div></section><section aria-labelledby="tying_it_together_with_javascript"><h3 id="tying_it_together_with_javascript"><a href="#tying_it_together_with_javascript">Tying it together with JavaScript</a></h3><div class="section-content"><p>That brings us to the JavaScript code which makes everything work. Let's start with the global variables:</p>
<div class="code-example"><p class="example-header"><span class="language-name">js</span></p><pre class="brush: js notranslate"><code><span class="token keyword">let</span> contentBox<span class="token punctuation">;</span>

<span class="token keyword">let</span> nextArticleID <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> visibleAds <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> previouslyVisibleAds <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> adObserver<span class="token punctuation">;</span>
<span class="token keyword">let</span> refreshIntervalID <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
</code></pre></div>
<p>These are used as follows:</p>
<dl>
  <dt id="contentbox"><a href="#contentbox"><code>contentBox</code></a></dt>
  <dd>
    <p>A reference to the <a href="/en-US/docs/Web/HTML/Element/main"><code>&lt;main&gt;</code></a> element's <a href="/en-US/docs/Web/API/HTMLElement"><code>HTMLElement</code></a> object in the DOM. This is where we'll insert the articles and ads.</p>
  </dd>
  <dt id="nextarticleid"><a href="#nextarticleid"><code>nextArticleID</code></a></dt>
  <dd>
    <p>Each article is given a unique ID number; this variable tracks the next ID to use, starting with 1.</p>
  </dd>
  <dt id="visibleads"><a href="#visibleads"><code>visibleAds</code></a></dt>
  <dd>
    <p>A <a href="/en-US/docs/Web/JavaScript/Reference/Global_Objects/Set"><code>Set</code></a> which we'll use to track the ads currently visible on the screen.</p>
  </dd>
  <dt id="previouslyvisibleads"><a href="#previouslyvisibleads"><code>previouslyVisibleAds</code></a></dt>
  <dd>
    <p>Used to temporarily store the list of visible ads while the document is not visible (for example, if the user has tabbed to another page).</p>
  </dd>
  <dt id="adobserver"><a href="#adobserver"><code>adObserver</code></a></dt>
  <dd>
    <p>Will hold our <a href="/en-US/docs/Web/API/IntersectionObserver"><code>IntersectionObserver</code></a> used to track the intersection between the ads and the <code>&lt;main&gt;</code> element's bounds.</p>
  </dd>
  <dt id="refreshintervalid"><a href="#refreshintervalid"><code>refreshIntervalID</code></a></dt>
  <dd>
    <p>Used to store the interval ID returned by <a href="/en-US/docs/Web/API/setInterval"><code>setInterval()</code></a>. This interval will be used to trigger our periodic refreshes of the ads' content.</p>
  </dd>
</dl>
<h4 id="setting_up">Setting up</h4>
<p>To set things up, we run the <code>startup()</code> function below when the page loads:</p>
<div class="code-example"><p class="example-header"><span class="language-name">js</span></p><pre class="brush: js notranslate"><code>window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">"load"</span><span class="token punctuation">,</span> startup<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">startup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  contentBox <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">"main"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">"visibilitychange"</span><span class="token punctuation">,</span> handleVisibilityChange<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> observerOptions <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">root</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token literal-property property">rootMargin</span><span class="token operator">:</span> <span class="token string">"0px"</span><span class="token punctuation">,</span>
    <span class="token literal-property property">threshold</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.75</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  adObserver <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IntersectionObserver</span><span class="token punctuation">(</span>intersectionCallback<span class="token punctuation">,</span> observerOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">buildContents</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  refreshIntervalID <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span>handleRefreshInterval<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p>First, a reference to the content wrapping <a href="/en-US/docs/Web/HTML/Element/main"><code>&lt;main&gt;</code></a> element is obtained, so we can insert our content into it. Then we set up an event listener for the <a href="/en-US/docs/Web/API/Document/visibilitychange_event" title="visibilitychange"><code>visibilitychange</code></a> event. This event is sent when the document becomes hidden or visible, such as when the user switches tabs in their browser. The Intersection Observer API doesn't take this into account when detecting intersection, since intersection isn't affected by page visibility. Therefore, we need to pause our timers while the page is tabbed out; hence this event listener.</p>
<p>Next we set up the options for the <a href="/en-US/docs/Web/API/IntersectionObserver"><code>IntersectionObserver</code></a> which will monitor target elements (ads, in our case) for intersection changes relative to the document. The options are configured to watch for intersections with the document's viewport (by setting <code>root</code> to <code>null</code>). We have no margins to extend or contract the intersection root's rectangle; we want to match the boundaries of the document's viewport exactly for intersection purposes. And the <code>threshold</code> is set to an array containing the values 0.0 and 0.75; this will cause our callback to execute whenever a targeted element becomes completely obscured or first starts to become unobscured (intersection ratio 0.0) or passes through 75% visible in either direction (intersection ratio 0.75).</p>
<p>The observer, <code>adObserver</code>, is created by calling <code>IntersectionObserver</code>'s constructor, passing in the callback function, <code>intersectionCallback</code>, and our options.</p>
<p>We then call a function <code>buildContents()</code>, which we'll define later to actually generate and insert into the document the articles and ads we want to present.</p>
<p>Finally, we set up an interval which triggers once a second to handle any necessary refreshing. We need a one second refresh since we're displaying timers in all visible ads for the purposes of this example. You may not need an interval at all, or you might do it differently or using a different time interval.</p>
<h4 id="handling_document_visibility_changes">Handling document visibility changes</h4>
<p>Let's take a look at the handler for the <a href="/en-US/docs/Web/API/Document/visibilitychange_event" title="visibilitychange"><code>visibilitychange</code></a> event. Our script receives this event when the document itself becomes visible or invisible. The most important scenario here is when the user switches tabs. Since Intersection Observer only cares about the intersection between the targeted elements and the intersection root, and not the tab's visibility (which is a different issue entirely), we need to use the <a href="/en-US/docs/Web/API/Page_Visibility_API">Page Visibility API</a> to detect these tab switches and disable our timers for the duration.</p>
<div class="code-example"><p class="example-header"><span class="language-name">js</span></p><pre class="brush: js notranslate"><code><span class="token keyword">function</span> <span class="token function">handleVisibilityChange</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>document<span class="token punctuation">.</span>hidden<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>previouslyVisibleAds<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      previouslyVisibleAds <span class="token operator">=</span> visibleAds<span class="token punctuation">;</span>
      visibleAds <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      previouslyVisibleAds<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">adBox</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">updateAdTimer</span><span class="token punctuation">(</span>adBox<span class="token punctuation">)</span><span class="token punctuation">;</span>
        adBox<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>lastViewStarted <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    previouslyVisibleAds<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">adBox</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      adBox<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>lastViewStarted <span class="token operator">=</span> performance<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    visibleAds <span class="token operator">=</span> previouslyVisibleAds<span class="token punctuation">;</span>
    previouslyVisibleAds <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p>Since the event itself doesn't state whether the document has switched from visible to invisible or vice versa, the <a href="/en-US/docs/Web/API/Document/hidden"><code>document.hidden</code></a> property is checked to see if the document is not currently visible. Since it's theoretically possible to get called multiple times, we only proceed if we haven't already paused the timers and saved the visibility states of the existing ads.</p>
<p>To pause the timers, all we need to do is remove the ads from the set of visible ads (<code>visibleAds</code>) and mark them as inactive. To do so, we begin by saving the set of visible ads into a variable known as <code>previouslyVisibleAds</code> to be sure we can restore them when the user tabs back into the document, and we then empty the <code>visibleAds</code> set so they won't be treated as visible. Then, for each of the ads that are being suspended, we call our <code>updateAdTimer()</code> function, which handles updating the ad's total visible time counter, then we set their <code>dataset.lastViewStarted</code> property to 0, which indicates that the tab's timer isn't running.</p>
<p>If the document has just become visible, we reverse this process: first we go through <code>previouslyVisibleAds</code> and set each one's <code>dataset.lastViewStarted</code> to the current document's time (in milliseconds since the document was created) using the <a href="/en-US/docs/Web/API/Performance/now" title="performance.now()"><code>performance.now()</code></a> method. Then we set <code>visibleAds</code> back to <code>previouslyVisibleAds</code> and set the latter to <code>null</code>. Now the ads are all restarted, and configured to know that they became visible at the current time, so that they will not add up the duration of time the page was tabbed away the next time they're updated.</p>
<h4 id="handling_intersection_changes">Handling intersection changes</h4>
<p>Once per pass through the browser's event loop, each <a href="/en-US/docs/Web/API/IntersectionObserver"><code>IntersectionObserver</code></a> checks to see if any of its target elements have passed through any of the observer's intersection ratio thresholds. For each observer, a list of targets that have done so is compiled, and sent to the observer's callback as an array of <a href="/en-US/docs/Web/API/IntersectionObserverEntry"><code>IntersectionObserverEntry</code></a> objects. Our callback, <code>intersectionCallback()</code>, looks like this:</p>
<div class="code-example"><p class="example-header"><span class="language-name">js</span></p><pre class="brush: js notranslate"><code><span class="token keyword">function</span> <span class="token function">intersectionCallback</span><span class="token punctuation">(</span><span class="token parameter">entries</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  entries<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">entry</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> adBox <span class="token operator">=</span> entry<span class="token punctuation">.</span>target<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>entry<span class="token punctuation">.</span>isIntersecting<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>entry<span class="token punctuation">.</span>intersectionRatio <span class="token operator">&gt;=</span> <span class="token number">0.75</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        adBox<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>lastViewStarted <span class="token operator">=</span> entry<span class="token punctuation">.</span>time<span class="token punctuation">;</span>
        visibleAds<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>adBox<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      visibleAds<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>adBox<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>
        entry<span class="token punctuation">.</span>intersectionRatio <span class="token operator">===</span> <span class="token number">0.0</span> <span class="token operator">&amp;&amp;</span>
        adBox<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>totalViewTime <span class="token operator">&gt;=</span> <span class="token number">60000</span>
      <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">replaceAd</span><span class="token punctuation">(</span>adBox<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p>As previously mentioned, the <a href="/en-US/docs/Web/API/IntersectionObserver"><code>IntersectionObserver</code></a> callback receives as input an array of all of the observer's targeted elements which have become either more or less visible than one of the intersection observer ratios. We iterate over each of those entries—which are of type <a href="/en-US/docs/Web/API/IntersectionObserverEntry"><code>IntersectionObserverEntry</code></a>. If the target element is intersecting with the root, we know it has just transitioned from the obscured state to the visible state. If it's become at least 75% visible, then we consider the ad visible and we start the timer by setting the ad's <code>dataset.lastViewStarted</code> attribute to the transition time in <a href="/en-US/docs/Web/API/IntersectionObserverEntry/time" title="entry.time"><code>entry.time</code></a>, then add the ad to the set <code>visibleAds</code> so we know to process it as time goes by.</p>
<p>If the ad has transitioned to the not-intersecting state, we remove the ad from the set of visible ads. Then we have one special behavior: we look to see if <a href="/en-US/docs/Web/API/IntersectionObserverEntry/intersectionRatio" title="entry.ratio"><code>entry.ratio</code></a> is 0.0; if it is, that means the element has become totally obscured. If that's the case, and the ad has been visible for at least a minute total, we call a function we'll create called <code>replaceAd()</code> to replace the existing ad with a new one. This way, the user sees a variety of ads over time, but the ads are only replaced while they can't be seen, resulting in a smooth experience.</p>
<h4 id="handling_periodic_actions">Handling periodic actions</h4>
<p>Our interval handler, <code>handleRefreshInterval()</code>, is called about once per second courtesy of the call to <a href="/en-US/docs/Web/API/setInterval"><code>setInterval()</code></a> made in the <code>startup()</code> function <a href="#setting_up">described above</a>. Its main job is to update the timers every second and schedule a redraw to update the timers we'll be drawing within each ad.</p>
<div class="code-example"><p class="example-header"><span class="language-name">js</span></p><pre class="brush: js notranslate"><code><span class="token keyword">function</span> <span class="token function">handleRefreshInterval</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> redrawList <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  visibleAds<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">adBox</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> previousTime <span class="token operator">=</span> adBox<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>totalViewTime<span class="token punctuation">;</span>
    <span class="token function">updateAdTimer</span><span class="token punctuation">(</span>adBox<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>previousTime <span class="token operator">!==</span> adBox<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>totalViewTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      redrawList<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>adBox<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>redrawList<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    window<span class="token punctuation">.</span><span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">time</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      redrawList<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">adBox</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">drawAdTimer</span><span class="token punctuation">(</span>adBox<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p>The array <code>redrawList</code> will be used to keep a list of all the ads which need to be redrawn during this refresh cycle, since it may not be exactly the same as the elapsed time due to system activity or because you've set the interval to something other than every 1000 milliseconds.</p>
<p>Then, for each of the visible ads, we save the value of <code>dataset.totalViewTime</code> (the total number of milliseconds the ad has currently been visible, as of the last time it was updated) and then call <code>updateAdTimer()</code> to update the time. If it's changed, then we push the ad onto the <code>redrawList</code> so we know it needs to be updated during the next animation frame.</p>
<p>Finally, if there's at least one element to redraw, we use <a href="/en-US/docs/Web/API/window/requestAnimationFrame" title="requestAnimationFrame()"><code>requestAnimationFrame()</code></a> to schedule a function that will redraw each element in the <code>redrawList</code> during the next animation frame.</p>
<h4 id="updating_an_ads_visibility_timer">Updating an ad's visibility timer</h4>
<p>Previously (see <a href="#handling_document_visibility_changes">Handling document visibility changes</a> and <a href="#handling_periodic_actions">Handling periodic actions</a>), we've seen that when we need to update an ad's "total visible time" counter, we call a function named <code>updateAdTimer()</code> to do so. This function takes as an input an ad's <a href="/en-US/docs/Web/API/HTMLDivElement"><code>HTMLDivElement</code></a> object. Here it is:</p>
<div class="code-example"><p class="example-header"><span class="language-name">js</span></p><pre class="brush: js notranslate"><code><span class="token keyword">function</span> <span class="token function">updateAdTimer</span><span class="token punctuation">(</span><span class="token parameter">adBox</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> lastStarted <span class="token operator">=</span> adBox<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>lastViewStarted<span class="token punctuation">;</span>
  <span class="token keyword">const</span> currentTime <span class="token operator">=</span> performance<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>lastStarted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> diff <span class="token operator">=</span> currentTime <span class="token operator">-</span> lastStarted<span class="token punctuation">;</span>

    adBox<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>totalViewTime <span class="token operator">=</span>
      <span class="token function">parseFloat</span><span class="token punctuation">(</span>adBox<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>totalViewTime<span class="token punctuation">)</span> <span class="token operator">+</span> diff<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  adBox<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>lastViewStarted <span class="token operator">=</span> currentTime<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p>To track an element's visible time, we use two custom data attributes (see <a href="/en-US/docs/Web/HTML/Global_attributes#data-*"><code>data-*</code></a>) on every ad:</p>
<dl>
  <dt id="lastviewstarted"><a href="#lastviewstarted"><code>lastViewStarted</code></a></dt>
  <dd>
    <p>The time in milliseconds, relative to the time at which the document was created, at which the ad's visibility count was last updated, or the ad last became visible. 0 if the ad was not visible as of the last time it was checked.</p>
  </dd>
  <dt id="totalviewtime"><a href="#totalviewtime"><code>totalViewTime</code></a></dt>
  <dd>
    <p>The total number of milliseconds the ad has been visible.</p>
  </dd>
</dl>
<p>These are accessed through each ad's <a href="/en-US/docs/Web/API/HTMLElement/dataset"><code>HTMLElement.dataset</code></a> attribute, which provides a <a href="/en-US/docs/Web/API/DOMStringMap"><code>DOMStringMap</code></a> mapping each custom attribute's name to its value. The values are strings, but we can convert those to numbers easily enough—in fact, JavaScript generally does it automatically, although we'll have one instance where we have to do it ourselves.</p>
<p>We start by fetching the time at which the ad's previous visibility status check time (<code>adBox.dataset.lastViewStarted</code>) into a local variable named <code>lastStarted</code>. We also get the current time-since-creation value using <a href="/en-US/docs/Web/API/Performance/now" title="performance.now()"><code>performance.now()</code></a> into <code>currentTime</code>.</p>
<p>If <code>lastStarted</code> is non-zero—meaning the timer is currently running, we compute the difference between the current time and the start time to determine the number of milliseconds the timer has been visible since the last time it became visible. This is added to the current value of the ad's <code>totalViewTime</code> to bring the total up to date. Note the use of <a href="/en-US/docs/Web/JavaScript/Reference/Global_Objects/parseFloat"><code>parseFloat()</code></a> here; because these values are strings, JavaScript tries to do a string concatenation instead of addition without it.</p>
<p>Finally, the last-viewed time for the ad is updated to the current time. This is done whether the ad was running when this function was called or not; this causes the ad's timer to always be running when this function returns. This makes sense because this function is only called if the ad is visible, even if it's just now become visible.</p>
<h4 id="drawing_an_ads_timer">Drawing an ad's timer</h4>
<p>Inside each ad, for demonstration purposes, we draw the current value of its <code>totalViewTime</code>, converted into minutes and seconds. This is handled by passing the ad's element into the <code>drawAdTimer()</code> function:</p>
<div class="code-example"><p class="example-header"><span class="language-name">js</span></p><pre class="brush: js notranslate"><code><span class="token keyword">function</span> <span class="token function">drawAdTimer</span><span class="token punctuation">(</span><span class="token parameter">adBox</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> timerBox <span class="token operator">=</span> adBox<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">".timer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> totalSeconds <span class="token operator">=</span> adBox<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>totalViewTime <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> sec <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>totalSeconds <span class="token operator">%</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> min <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>totalSeconds <span class="token operator">/</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  timerBox<span class="token punctuation">.</span>innerText <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>min<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>sec<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">padStart</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"0"</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p>This code finds the ad's timer using its ID, <code>"timer"</code>, and computes the number of seconds elapsed by dividing the ad's <code>totalViewTime</code> by 1000. Then it calculates the number of minutes and seconds elapsed before setting the timer's <a href="/en-US/docs/Web/API/HTMLElement/innerText" title="innerText"><code>innerText</code></a> to a string representing that time in the form m:ss. The <a href="/en-US/docs/Web/JavaScript/Reference/Global_Objects/String/padStart"><code>String.padStart()</code></a> method is used to ensure that the number of seconds is padded out to two digits if it's less than 10.</p>
<h4 id="building_the_page_contents">Building the page contents</h4>
<p>The <code>buildContents()</code> function is called by the <a href="#setting_up">startup code</a> to select and insert into the document the articles and ads to be presented:</p>
<div class="code-example"><p class="example-header"><span class="language-name">js</span></p><pre class="brush: js notranslate"><code><span class="token keyword">const</span> loremIpsum <span class="token operator">=</span>
  <span class="token string">"&lt;p&gt;Lorem ipsum dolor sit amet, consectetur adipiscing"</span> <span class="token operator">+</span>
  <span class="token string">" elit. Cras at sem diam. Vestibulum venenatis massa in tincidunt"</span> <span class="token operator">+</span>
  <span class="token string">" egestas. Morbi eu lorem vel est sodales auctor hendrerit placerat"</span> <span class="token operator">+</span>
  <span class="token string">" risus. Etiam rutrum faucibus sem, vitae mattis ipsum ullamcorper"</span> <span class="token operator">+</span>
  <span class="token string">" eu. Donec nec imperdiet nibh, nec vehicula libero. Phasellus vel"</span> <span class="token operator">+</span>
  <span class="token string">" malesuada nulla. Aliquam sed magna aliquam, vestibulum nisi at,"</span> <span class="token operator">+</span>
  <span class="token string">" cursus nunc.&lt;/p&gt;"</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">buildContents</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    contentBox<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span><span class="token function">createArticle</span><span class="token punctuation">(</span>loremIpsum<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>i <span class="token operator">%</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">loadRandomAd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p>The variable <code>loremIpsum</code> contains the text we'll use for the body of all of our articles. Obviously in the real world, you'd have some code to pull articles from a database or the like, but this does the job for our purposes. Every article uses the same text; you could of course change that easily enough.</p>
<p><code>buildContents()</code> creates a page with five articles. Following every odd-numbered article, an ad is "loaded" and inserted into the page. Articles are inserted into the content box (that is, the <a href="/en-US/docs/Web/HTML/Element/main"><code>&lt;main&gt;</code></a> element that contains all the site content) after being created using a method called <code>createArticle()</code>, which we'll look at next.</p>
<p>The ads are created using a function called <code>loadRandomAd()</code>, which both creates the ad and inserts it into the page. We'll see later that this same function can also replace an existing ad, but for now, we're appending ads to the existing content.</p>
<h4 id="creating_an_article">Creating an article</h4>
<p>To create the <a href="/en-US/docs/Web/HTML/Element/article"><code>&lt;article&gt;</code></a> element for an article (as well as all of its contents), we use the <code>createArticle()</code> function, which takes as input a string which is the full text of the article to add to the page.</p>
<div class="code-example"><p class="example-header"><span class="language-name">js</span></p><pre class="brush: js notranslate"><code><span class="token keyword">function</span> <span class="token function">createArticle</span><span class="token punctuation">(</span><span class="token parameter">contents</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> articleElem <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">"article"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  articleElem<span class="token punctuation">.</span>id <span class="token operator">=</span> nextArticleID<span class="token punctuation">;</span>

  <span class="token keyword">const</span> titleElem <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">"h2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  titleElem<span class="token punctuation">.</span>innerText <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Article </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>nextArticleID<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> title</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
  articleElem<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>titleElem<span class="token punctuation">)</span><span class="token punctuation">;</span>

  articleElem<span class="token punctuation">.</span>innerHTML <span class="token operator">+=</span> contents<span class="token punctuation">;</span>
  nextArticleID <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> articleElem<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p>First, the <code>&lt;article&gt;</code> element is created and its ID is set to the unique value <code>nextArticleID</code> (which starts at 1 and goes up for each article). Then we create and append an <a href="/en-US/docs/Web/HTML/Element/Heading_Elements">h2</a> element for the article title and then we append the HTML from <code>contents</code> to that. Finally, <code>nextArticleID</code> is incremented (so that the next element gets a new unique ID) and we return the new <code>&lt;article&gt;</code> element to the caller.</p>
<h4 id="creating_an_ad">Creating an ad</h4>
<p>The <code>loadRandomAd()</code> function simulates loading an ad and adding it to the page. If you don't pass a value for <code>replaceBox</code>, a new element is created to contain the ad; the ad is then appended to the page. If you specify a <code>replaceBox</code>, that box is treated as an existing ad element; instead of creating a new one, the existing element is changed to contain the new ad's style, content, and other data. This avoids the risk of lengthy layout work being done when you update the ad, which could happen if you first delete the old element then insert a new one.</p>
<div class="code-example"><p class="example-header"><span class="language-name">js</span></p><pre class="brush: js notranslate"><code><span class="token keyword">function</span> <span class="token function">loadRandomAd</span><span class="token punctuation">(</span><span class="token parameter">replaceBox</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> ads <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token literal-property property">bgcolor</span><span class="token operator">:</span> <span class="token string">"#cec"</span><span class="token punctuation">,</span>
      <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">"Eat Green Beans"</span><span class="token punctuation">,</span>
      <span class="token literal-property property">body</span><span class="token operator">:</span> <span class="token string">"Make your mother proud—they're good for you!"</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token literal-property property">bgcolor</span><span class="token operator">:</span> <span class="token string">"aquamarine"</span><span class="token punctuation">,</span>
      <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">"MillionsOfFreeBooks.whatever"</span><span class="token punctuation">,</span>
      <span class="token literal-property property">body</span><span class="token operator">:</span> <span class="token string">"Read classic literature online free!"</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token literal-property property">bgcolor</span><span class="token operator">:</span> <span class="token string">"lightgrey"</span><span class="token punctuation">,</span>
      <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">"3.14 Shades of Gray: A novel"</span><span class="token punctuation">,</span>
      <span class="token literal-property property">body</span><span class="token operator">:</span> <span class="token string">"Love really does make the world go round…"</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token literal-property property">bgcolor</span><span class="token operator">:</span> <span class="token string">"#fee"</span><span class="token punctuation">,</span>
      <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">"Flexbox Florist"</span><span class="token punctuation">,</span>
      <span class="token literal-property property">body</span><span class="token operator">:</span> <span class="token string">"When life's layout gets complicated, send flowers."</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> adBox<span class="token punctuation">,</span> title<span class="token punctuation">,</span> body<span class="token punctuation">,</span> timerElem<span class="token punctuation">;</span>

  <span class="token keyword">const</span> ad <span class="token operator">=</span> ads<span class="token punctuation">[</span>Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> ads<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>replaceBox<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    adObserver<span class="token punctuation">.</span><span class="token function">unobserve</span><span class="token punctuation">(</span>replaceBox<span class="token punctuation">)</span><span class="token punctuation">;</span>
    adBox <span class="token operator">=</span> replaceBox<span class="token punctuation">;</span>
    title <span class="token operator">=</span> replaceBox<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">".title"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    body <span class="token operator">=</span> replaceBox<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">".body"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    timerElem <span class="token operator">=</span> replaceBox<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">".timer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    adBox <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">"div"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    adBox<span class="token punctuation">.</span>className <span class="token operator">=</span> <span class="token string">"ad"</span><span class="token punctuation">;</span>
    title <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">"h2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    body <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">"p"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    timerElem <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">"div"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    adBox<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>title<span class="token punctuation">)</span><span class="token punctuation">;</span>
    adBox<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
    adBox<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>timerElem<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  adBox<span class="token punctuation">.</span>style<span class="token punctuation">.</span>backgroundColor <span class="token operator">=</span> ad<span class="token punctuation">.</span>bgcolor<span class="token punctuation">;</span>

  title<span class="token punctuation">.</span>className <span class="token operator">=</span> <span class="token string">"title"</span><span class="token punctuation">;</span>
  body<span class="token punctuation">.</span>className <span class="token operator">=</span> <span class="token string">"body"</span><span class="token punctuation">;</span>
  title<span class="token punctuation">.</span>innerText <span class="token operator">=</span> ad<span class="token punctuation">.</span>title<span class="token punctuation">;</span>
  body<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> ad<span class="token punctuation">.</span>body<span class="token punctuation">;</span>

  adBox<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>totalViewTime <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  adBox<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>lastViewStarted <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  timerElem<span class="token punctuation">.</span>className <span class="token operator">=</span> <span class="token string">"timer"</span><span class="token punctuation">;</span>
  timerElem<span class="token punctuation">.</span>innerText <span class="token operator">=</span> <span class="token string">"0:00"</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>replaceBox<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    contentBox<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>adBox<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  adObserver<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span>adBox<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p>First is the array <code>ads</code>. This array contains the data needed to create each ad. We have four here to choose from at random. In a real-world scenario, of course, the ads would come from a database or, more likely, an advertising service from which you fetch ads using an API. However, our needs are simple: each ad is represented by an object with three properties: a background color (<code>bgcolor</code>), a title (<code>title</code>), and a body text string (<code>body</code>).</p>
<p>Then we define several variables:</p>
<dl>
  <dt id="adbox"><a href="#adbox"><code>adBox</code></a></dt>
  <dd>
    <p>This will be set to the element that represents the ad. For new ads being appended to the page, this is created using <a href="/en-US/docs/Web/API/Document/createElement"><code>Document.createElement()</code></a>. When replacing an existing ad, this is set to the specified ad element (<code>replaceBox</code>).</p>
  </dd>
  <dt id="title"><a href="#title"><code>title</code></a></dt>
  <dd>
    <p>Will hold the <a href="/en-US/docs/Web/HTML/Element/Heading_Elements">h2</a> element representing the ad's title.</p>
  </dd>
  <dt id="body"><a href="#body"><code>body</code></a></dt>
  <dd>
    <p>Will hold the <a href="/en-US/docs/Web/HTML/Element/p"><code>&lt;p&gt;</code></a> representing the ad's body text.</p>
  </dd>
  <dt id="timerelem"><a href="#timerelem"><code>timerElem</code></a></dt>
  <dd>
    <p>Will hold the <a href="/en-US/docs/Web/HTML/Element/div"><code>&lt;div&gt;</code></a> element which contains the time the ad has been visible so far.</p>
  </dd>
</dl>
<p>A random ad is selected by computing <code>Math.floor(Math.random() * ads.length)</code>; the result is a value between 0 and one less than the number of ads. The corresponding ad is now known as <code>adBox</code>.</p>
<p>If a value is specified for <code>replaceBox</code>, we use that as the ad element. To do so, we begin by ending observation of the element by calling <a href="/en-US/docs/Web/API/IntersectionObserver/unobserve"><code>IntersectionObserver.unobserve()</code></a>. Then the local variables for each of the elements that comprise an ad: the ad box itself, the title, the body, and the timer box, are all set to the corresponding elements in the existing ad.</p>
<p>If no value is specified for replaceBox, we create a new ad element. The ad's new <a href="/en-US/docs/Web/HTML/Element/div"><code>&lt;div&gt;</code></a> element is created and its properties established by setting its class name to <code>"ad"</code>. Next, the ad title element is created, along with the body and the visibility timer; these are an <a href="/en-US/docs/Web/HTML/Element/Heading_Elements">h2</a>, a <a href="/en-US/docs/Web/HTML/Element/p"><code>&lt;p&gt;</code></a>, and a <a href="/en-US/docs/Web/HTML/Element/div"><code>&lt;div&gt;</code></a> element, respectively. These elements are appended to the <code>adBox</code> element.</p>
<p>After that, the code paths converge once again. The ad's background color is set to the value specified in the new ad's record, and elements' classes and contents are set appropriately as well.</p>
<p>Next, it's time to set up the custom data properties to track the ad's visibility data by setting <code>adBox.dataset.totalViewTime</code> and <code>adBox.dataset.lastViewStarted</code> to 0.</p>
<p>Finally, we set the ID of the <code>&lt;div&gt;</code> which will show the timer we'll present in the ad to show how long it's been visible, giving it the class <code>"timer"</code>. The initial text is set to "0:00", to represent the starting time of 0 minutes and 0 seconds, and it's appended to the ad.</p>
<p>If we're not replacing an existing ad, we need to append the element to the content area of the page using <a href="/en-US/docs/Web/API/Node/appendChild" title="Document.appendChild()"><code>Document.appendChild()</code></a>. If we're replacing an ad, it's already there, with its contents replaced with the new ad's. Then we call the <a href="/en-US/docs/Web/API/IntersectionObserver/observe" title="observe()"><code>observe()</code></a> method on our Intersection Observer, <code>adObserver</code>, to start watching the ad for changes to its intersection with the viewport. From now on, any time the ad becomes 100% obscured or even a single pixel becomes visible, or the ad passes through 75% visible in one way or another, the <a href="#handling_intersection_changes">observer's callback</a> is executed.</p>
<h4 id="replacing_an_existing_ad">Replacing an existing ad</h4>
<p>Our <a href="#handling_intersection_changes">observer's callback</a> keeps an eye out for ads which become 100% obscured and have a total visible time of at least one minute. When that happens, the <code>replaceAd()</code> function is called with that ad's element as an input, so that the old ad can be replaced with a new one.</p>
<div class="code-example"><p class="example-header"><span class="language-name">js</span></p><pre class="brush: js notranslate"><code><span class="token keyword">function</span> <span class="token function">replaceAd</span><span class="token punctuation">(</span><span class="token parameter">adBox</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">updateAdTimer</span><span class="token punctuation">(</span>adBox<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> visibleTime <span class="token operator">=</span> adBox<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>totalViewTime<span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
    <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Replacing ad: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>
      adBox<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">"h2"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText
    <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> - visible for </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>visibleTime<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">loadRandomAd</span><span class="token punctuation">(</span>adBox<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p><code>replaceAd()</code> begins by calling <code>updateAdTimer()</code> on the existing ad, to ensure that its timer is up-to-date. This ensures that when we read its <code>totalViewTime</code>, we see the exact final value for how long the ad was visible to the user. We then report that data; in this case, by logging it to console, but in the real world, you'd submit the information to an ad service's API or save it into a database.</p>
<p>Then we load a new ad by calling <a href="#creating_an_ad"><code>loadRandomAd()</code></a>, specifying the ad to be replaced as an input parameter. As we saw previously, <code>loadRandomAd()</code> will replace an existing ad with content and data corresponding to a new ad, if you specify an existing ad's element as an input parameter.</p>
<p>The new ad's element object is returned to the caller in case it's needed.</p></div></section><section aria-labelledby="result"><h3 id="result"><a href="#result">Result</a></h3><div class="section-content"><p>The resulting page looks like this. Try experimenting by scrolling up and down and notice how changes in the visibility affect the timers in each ad. Also note that each ad is replaced after one minute of visibility (but the ad must first be scrolled out of view and back again), and how the timers pause while the document is tabbed into the background. However, covering the browser with another window does not pause the timers.</p><div class="code-example" id="sect1"><p class="example-header"></p><iframe class="sample-code-frame" title="Building the site sample" id="frame_building_the_site" width="750" height="800" src="http://localhost:5042/en-US/docs/Web/API/Intersection_Observer_API/Timing_element_visibility/runner.html?id=building_the_site" loading="lazy"></iframe></div></div></section><section aria-labelledby="see_also"><h2 id="see_also"><a href="#see_also">See also</a></h2><div class="section-content"><ul>
  <li><a href="/en-US/docs/Web/API/Intersection_Observer_API">Intersection Observer API</a></li>
  <li><a href="/en-US/docs/Web/API/Page_Visibility_API">Page Visibility API</a></li>
</ul></div></section><aside class="metadata"><div class="metadata-content-container"><div id="on-github" class="on-github"><h3>Found a content problem with this page?</h3><ul><li><a href="https://github.com/mdn/content/edit/main/files/en-us/web/api/intersection_observer_api/timing_element_visibility/index.md" title="This will take you to GitHub, where you&#x27;ll need to sign in first." target="_blank" rel="noopener noreferrer">Edit the page on GitHub</a>.</li><li><a href="https://github.com/mdn/content/issues/new?template=page-report.yml&amp;mdn-url=https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FWeb%2FAPI%2FIntersection_Observer_API%2FTiming_element_visibility&amp;metadata=%3C%21--+Do+not+make+changes+below+this+line+--%3E%0A%3Cdetails%3E%0A%3Csummary%3EPage+report+details%3C%2Fsummary%3E%0A%0A*+Folder%3A+%60en-us%2Fweb%2Fapi%2Fintersection_observer_api%2Ftiming_element_visibility%60%0A*+MDN+URL%3A+https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FWeb%2FAPI%2FIntersection_Observer_API%2FTiming_element_visibility%0A*+GitHub+URL%3A+https%3A%2F%2Fgithub.com%2Fmdn%2Fcontent%2Fblob%2Fmain%2Ffiles%2Fen-us%2Fweb%2Fapi%2Fintersection_observer_api%2Ftiming_element_visibility%2Findex.md%0A*+Last+commit%3A+https%3A%2F%2Fgithub.com%2Fmdn%2Fcontent%2Fcommit%2F76717f752447b6eef25bf29c12272e407ee5cb6b%0A*+Document+last+modified%3A+2023-07-17T23%3A17%3A51.000Z%0A%0A%3C%2Fdetails%3E" title="This will take you to GitHub to file a new issue." target="_blank" rel="noopener noreferrer">Report the content issue</a>.</li><li><a href="https://github.com/mdn/content/blob/main/files/en-us/web/api/intersection_observer_api/timing_element_visibility/index.md?plain=1" title="Folder: en-us/web/api/intersection_observer_api/timing_element_visibility (Opens in a new tab)" target="_blank" rel="noopener noreferrer">View the source on GitHub</a>.</li></ul>Want to get more involved?<!-- --> <a href="https://github.com/mdn/content/blob/main/CONTRIBUTING.md" title="This will take you to our contribution guidelines on GitHub." target="_blank" rel="noopener noreferrer">Learn how to contribute</a>.</div><p class="last-modified-date">This page was last modified on<!-- --> <time dateTime="2023-07-17T23:17:51.000Z">Jul 18, 2023</time> by<!-- --> <a href="/en-US/docs/Web/API/Intersection_Observer_API/Timing_element_visibility/contributors.txt">MDN contributors</a>.</p></div></aside></article></main></div></div><footer id="nav-footer" class="page-footer"><div class="page-footer-grid"><div class="page-footer-logo-col"><a href="/" class="mdn-footer-logo" aria-label="MDN homepage"><svg width="48" height="17" viewBox="0 0 48 17" fill="none" xmlns="http://www.w3.org/2000/svg"><title id="mdn-footer-logo-svg">MDN logo</title><path d="M20.04 16.512H15.504V10.416C15.504 9.488 15.344 8.824 15.024 8.424C14.72 8.024 14.264 7.824 13.656 7.824C12.92 7.824 12.384 8.064 12.048 8.544C11.728 9.024 11.568 9.64 11.568 10.392V14.184H13.008V16.512H8.472V10.416C8.472 9.488 8.312 8.824 7.992 8.424C7.688 8.024 7.232 7.824 6.624 7.824C5.872 7.824 5.336 8.064 5.016 8.544C4.696 9.024 4.536 9.64 4.536 10.392V14.184H6.6V16.512H0V14.184H1.44V8.04H0.024V5.688H4.536V7.32C5.224 6.088 6.32 5.472 7.824 5.472C8.608 5.472 9.328 5.664 9.984 6.048C10.64 6.432 11.096 7.016 11.352 7.8C11.992 6.248 13.168 5.472 14.88 5.472C15.856 5.472 16.72 5.776 17.472 6.384C18.224 6.992 18.6 7.936 18.6 9.216V14.184H20.04V16.512Z" fill="currentColor"></path><path d="M33.6714 16.512H29.1354V14.496C28.8314 15.12 28.3834 15.656 27.7914 16.104C27.1994 16.536 26.4154 16.752 25.4394 16.752C24.0154 16.752 22.8954 16.264 22.0794 15.288C21.2634 14.312 20.8554 12.984 20.8554 11.304C20.8554 9.688 21.2554 8.312 22.0554 7.176C22.8554 6.04 24.0634 5.472 25.6794 5.472C26.5594 5.472 27.2794 5.648 27.8394 6C28.3994 6.352 28.8314 6.8 29.1354 7.344V2.352H26.9754V0H32.2314V14.184H33.6714V16.512ZM29.1354 11.04V10.776C29.1354 9.88 28.8954 9.184 28.4154 8.688C27.9514 8.176 27.3674 7.92 26.6634 7.92C25.9754 7.92 25.3674 8.176 24.8394 8.688C24.3274 9.2 24.0714 10.008 24.0714 11.112C24.0714 12.152 24.3114 12.944 24.7914 13.488C25.2714 14.032 25.8394 14.304 26.4954 14.304C27.3114 14.304 27.9514 13.96 28.4154 13.272C28.8954 12.584 29.1354 11.84 29.1354 11.04Z" fill="currentColor"></path><path d="M47.9589 16.512H41.9829V14.184H43.4229V10.416C43.4229 9.488 43.2629 8.824 42.9429 8.424C42.6389 8.024 42.1829 7.824 41.5749 7.824C40.8389 7.824 40.2709 8.056 39.8709 8.52C39.4709 8.968 39.2629 9.56 39.2469 10.296V14.184H40.6869V16.512H34.7109V14.184H36.1509V8.04H34.5909V5.688H39.2469V7.344C39.9669 6.096 41.1269 5.472 42.7269 5.472C43.7509 5.472 44.6389 5.776 45.3909 6.384C46.1429 6.992 46.5189 7.936 46.5189 9.216V14.184H47.9589V16.512Z" fill="currentColor"></path></svg></a><p>Your blueprint for a better internet.</p><ul class="social-icons"><li><a class="icon icon-mastodon" href="https://mozilla.social/@mdn" target="_blank" rel="me noopener noreferrer"><span class="visually-hidden">MDN on Mastodon</span></a></li><li><a class="icon icon-twitter" href="https://twitter.com/mozdevnet" target="_blank" rel="noopener noreferrer"><span class="visually-hidden">MDN on Twitter</span></a></li><li><a class="icon icon-github-mark-small" href="https://github.com/mdn/" target="_blank" rel="noopener noreferrer"><span class="visually-hidden">MDN on GitHub</span></a></li><li><a class="icon icon-feed" href="/en-US/blog/rss.xml" target="_blank"><span class="visually-hidden">MDN Blog RSS Feed</span></a></li></ul></div><div class="page-footer-nav-col-1"><h2 class="footer-nav-heading">MDN</h2><ul class="footer-nav-list"><li class="footer-nav-item"><a href="/en-US/about">About</a></li><li class="footer-nav-item"><a href="/en-US/blog/">Blog</a></li><li class="footer-nav-item"><a href="https://www.mozilla.org/en-US/careers/listings/?team=ProdOps" target="_blank" rel="noopener noreferrer">Careers</a></li><li class="footer-nav-item"><a href="/en-US/advertising">Advertise with us</a></li></ul></div><div class="page-footer-nav-col-2"><h2 class="footer-nav-heading">Support</h2><ul class="footer-nav-list"><li class="footer-nav-item"><a class="footer-nav-link" href="/en-US/docs/MDN/Community/Issues">Report an issue</a></li></ul></div><div class="page-footer-nav-col-3"><h2 class="footer-nav-heading">Our communities</h2><ul class="footer-nav-list"><li class="footer-nav-item"><a class="footer-nav-link" href="/en-US/community">MDN Community</a></li><li class="footer-nav-item"><a class="footer-nav-link" href="https://discourse.mozilla.org/c/mdn/236" target="_blank" rel="noopener noreferrer">MDN Forum</a></li><li class="footer-nav-item"><a class="footer-nav-link" href="/discord" target="_blank" rel="noopener noreferrer">MDN Chat</a></li></ul></div><div class="page-footer-nav-col-4"><h2 class="footer-nav-heading">Developers</h2><ul class="footer-nav-list"><li class="footer-nav-item"><a class="footer-nav-link" href="/en-US/docs/Web">Web Technologies</a></li><li class="footer-nav-item"><a class="footer-nav-link" href="/en-US/docs/Learn">Learn Web Development</a></li><li class="footer-nav-item"><a href="https://hacks.mozilla.org/" target="_blank" rel="noopener noreferrer">Hacks Blog</a></li></ul></div><div class="page-footer-moz"><a href="https://www.mozilla.org/" class="footer-moz-logo-link" target="_blank" rel="noopener noreferrer"><svg width="112" height="32" fill="none" xmlns="http://www.w3.org/2000/svg"><title id="mozilla-footer-logo-svg">Mozilla logo</title><path d="M41.753 14.218c-2.048 0-3.324 1.522-3.324 4.157 0 2.423 1.119 4.286 3.29 4.286 2.082 0 3.447-1.678 3.447-4.347 0-2.826-1.522-4.096-3.413-4.096Zm54.89 7.044c0 .901.437 1.618 1.645 1.618 1.427 0 2.949-1.024 3.044-3.352-.649-.095-1.365-.185-2.02-.185-1.426-.005-2.668.397-2.668 1.92Z" fill="currentColor"></path><path d="M0 0v32h111.908V0H0Zm32.56 25.426h-5.87v-7.884c0-2.423-.806-3.352-2.39-3.352-1.924 0-2.702 1.365-2.702 3.324v4.868h1.864v3.044h-5.864v-7.884c0-2.423-.806-3.352-2.39-3.352-1.924 0-2.702 1.365-2.702 3.324v4.868h2.669v3.044H6.642v-3.044h1.863v-7.918H6.642V11.42h5.864v2.11c.839-1.489 2.3-2.39 4.252-2.39 2.02 0 3.878.963 4.566 3.01.778-1.862 2.361-3.01 4.566-3.01 2.512 0 4.812 1.522 4.812 4.84v6.402h1.863v3.044h-.005Zm9.036.307c-4.314 0-7.296-2.635-7.296-7.106 0-4.096 2.484-7.481 7.514-7.481s7.481 3.38 7.481 7.29c0 4.472-3.228 7.297-7.699 7.297Zm22.578-.307H51.942l-.403-2.11 7.7-8.846h-4.376l-.621 2.17-2.888-.313.498-4.907h12.294l.313 2.11-7.767 8.852h4.533l.654-2.172 3.167.308-.872 4.908Zm7.99 0h-4.191v-5.03h4.19v5.03Zm0-8.976h-4.191v-5.03h4.19v5.03Zm2.618 8.976 6.054-21.358h3.945l-6.054 21.358h-3.945Zm8.136 0 6.048-21.358h3.945l-6.054 21.358h-3.939Zm21.486.307c-1.863 0-2.887-1.085-3.072-2.792-.805 1.427-2.232 2.792-4.498 2.792-2.02 0-4.314-1.085-4.314-4.006 0-3.447 3.323-4.253 6.518-4.253.778 0 1.584.034 2.3.124v-.465c0-1.427-.034-3.133-2.3-3.133-.84 0-1.488.061-2.143.402l-.453 1.578-3.195-.34.549-3.224c2.45-.996 3.692-1.27 5.992-1.27 3.01 0 5.556 1.55 5.556 4.75v6.083c0 .805.314 1.085.963 1.085.184 0 .375-.034.587-.095l.034 2.11a5.432 5.432 0 0 1-2.524.654Z" fill="currentColor"></path></svg></a><ul class="footer-moz-list"><li class="footer-moz-item"><a href="https://www.mozilla.org/privacy/websites/" class="footer-moz-link" target="_blank" rel="noopener noreferrer">Website Privacy Notice</a></li><li class="footer-moz-item"><a href="https://www.mozilla.org/privacy/websites/#cookies" class="footer-moz-link" target="_blank" rel="noopener noreferrer">Cookies</a></li><li class="footer-moz-item"><a href="https://www.mozilla.org/about/legal/terms/mozilla" class="footer-moz-link" target="_blank" rel="noopener noreferrer">Legal</a></li><li class="footer-moz-item"><a href="https://www.mozilla.org/about/governance/policies/participation/" class="footer-moz-link" target="_blank" rel="noopener noreferrer">Community Participation Guidelines</a></li></ul></div><div class="page-footer-legal"><p id="license" class="page-footer-legal-text">Visit<!-- --> <a href="https://www.mozilla.org" target="_blank" rel="noopener noreferrer">Mozilla Corporation’s</a> <!-- -->not-for-profit parent, the<!-- --> <a target="_blank" rel="noopener noreferrer" href="https://foundation.mozilla.org/">Mozilla Foundation</a>.<br/>Portions of this content are ©1998–<!-- -->2023<!-- --> by individual mozilla.org contributors. Content available under<!-- --> <a href="/en-US/docs/MDN/Writing_guidelines/Attrib_copyright_license">a Creative Commons license</a>.</p></div></div></footer></div><script type="application/json" id="hydration">{"doc":{"isMarkdown":true,"isTranslated":false,"isActive":true,"flaws":{},"title":"Timing element visibility with the Intersection Observer API","mdn_url":"/en-US/docs/Web/API/Intersection_Observer_API/Timing_element_visibility","locale":"en-US","native":"English (US)","sidebarHTML":"<ol><li><strong><a href=\"/en-US/docs/Web/API/Intersection_Observer_API\">Intersection Observer API</a></strong></li><li class=\"toggle\"><details open=\"\"><summary>Guides</summary><ol><li><em><a href=\"/en-US/docs/Web/API/Intersection_Observer_API/Timing_element_visibility\" aria-current=\"page\">Timing element visibility with the Intersection Observer API</a></em></li></ol></details></li><li class=\"toggle\"><details open=\"\"><summary>Interfaces</summary><ol><li><a href=\"/en-US/docs/Web/API/IntersectionObserver\"><code>IntersectionObserver</code></a></li><li><a href=\"/en-US/docs/Web/API/IntersectionObserverEntry\"><code>IntersectionObserverEntry</code></a></li></ol></details></li></ol>","sidebarMacro":"DefaultAPISidebar","body":[{"type":"prose","value":{"id":null,"title":null,"isH3":false,"content":"<p>In this article, we'll build a mock blog which has a number of ads interspersed among the contents of the page, then use the <a href=\"/en-US/docs/Web/API/Intersection_Observer_API\">Intersection Observer API</a> to track how much time each ad is visible to the user. When an ad exceeds one minute of visible time, it will be replaced with a new one.</p>\n<p>Although many aspects of this example will not match real-world usage (in particular, the articles all have the same text and aren't loaded from a database, and there are just a handful of simple text-only ads that are selected from an array), this should provide enough understanding of the API to quickly learn how to apply the Intersection Observer API to your own site.</p>\n<p>There's a good reason why the notion of tracking visibility of ads is being used in this example. It turns out that one of the most common uses of Flash or other script in advertising on the Web is to record how long each ad is visible, for the purpose of billing and payment of revenues. Without the Intersection Observer API, this winds up being done using intervals and timeouts for each individual ad, or other techniques that tend to slow the page down. Using this API lets everything get streamlined by the browser to reduce the impact on performance substantially.</p>\n<p>Let's get started!</p>"}},{"type":"prose","value":{"id":"building_the_site","title":"Building the site","isH3":false,"content":""}},{"type":"prose","value":{"id":"site_structure_the_html","title":"Site structure: The HTML","isH3":true,"content":"<p>The site's structure is not too complicated. We'll be using <a href=\"/en-US/docs/Web/CSS/CSS_grid_layout\">CSS Grid</a> to style and lay out the site, so we can be pretty straightforward here:</p>\n<div class=\"code-example\"><p class=\"example-header\"><span class=\"language-name\">html</span></p><pre class=\"brush: html notranslate\"><code><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>wrapper<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">&gt;</span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>header</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>h1</span><span class=\"token punctuation\">&gt;</span></span>A Fake Blog<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>h1</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>h2</span><span class=\"token punctuation\">&gt;</span></span>Showing Intersection Observer in action!<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>h2</span><span class=\"token punctuation\">&gt;</span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>header</span><span class=\"token punctuation\">&gt;</span></span>\n\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>aside</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>nav</span><span class=\"token punctuation\">&gt;</span></span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>ul</span><span class=\"token punctuation\">&gt;</span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>li</span><span class=\"token punctuation\">&gt;</span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>a</span> <span class=\"token attr-name\">href</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>#link1<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">&gt;</span></span>A link<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>a</span><span class=\"token punctuation\">&gt;</span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>li</span><span class=\"token punctuation\">&gt;</span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>li</span><span class=\"token punctuation\">&gt;</span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>a</span> <span class=\"token attr-name\">href</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>#link2<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">&gt;</span></span>Another link<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>a</span><span class=\"token punctuation\">&gt;</span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>li</span><span class=\"token punctuation\">&gt;</span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>li</span><span class=\"token punctuation\">&gt;</span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>a</span> <span class=\"token attr-name\">href</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>#link3<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">&gt;</span></span>One more link<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>a</span><span class=\"token punctuation\">&gt;</span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>li</span><span class=\"token punctuation\">&gt;</span></span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>ul</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>nav</span><span class=\"token punctuation\">&gt;</span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>aside</span><span class=\"token punctuation\">&gt;</span></span>\n\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>main</span><span class=\"token punctuation\">&gt;</span></span>…<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>main</span><span class=\"token punctuation\">&gt;</span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">&gt;</span></span>\n</code></pre></div>\n<p>This is the framework for the entire site. At the top is the site's header region, contained within a <a href=\"/en-US/docs/Web/HTML/Element/header\"><code>&lt;header&gt;</code></a> block. Below that, we define the site's sidebar as a list of links within an <a href=\"/en-US/docs/Web/HTML/Element/aside\"><code>&lt;aside&gt;</code></a> block.</p>\n<p>Finally comes the main body. We start with an empty <a href=\"/en-US/docs/Web/HTML/Element/main\"><code>&lt;main&gt;</code></a> element here. This box will be populated using script later.</p>"}},{"type":"prose","value":{"id":"styling_the_site_with_css","title":"Styling the site with CSS","isH3":true,"content":"<p>With the structure of the site defined, we turn to the styling for the site. Let's look at the style for each component of the page individually.</p>\n<h4 id=\"the_basics\">The basics</h4>\n<p>We provide styles for the <a href=\"/en-US/docs/Web/HTML/Element/body\"><code>&lt;body&gt;</code></a> and <a href=\"/en-US/docs/Web/HTML/Element/main\"><code>&lt;main&gt;</code></a> elements to define the site's background as well as the grid the various parts of the site will be placed in.</p>\n<div class=\"code-example\"><p class=\"example-header\"><span class=\"language-name\">css</span></p><pre class=\"brush: css notranslate\"><code><span class=\"token selector\">body</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">font-family</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"Open Sans\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Arial\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Helvetica\"</span><span class=\"token punctuation\">,</span> sans-serif<span class=\"token punctuation\">;</span>\n  <span class=\"token property\">background-color</span><span class=\"token punctuation\">:</span> aliceblue<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token selector\">.wrapper</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">display</span><span class=\"token punctuation\">:</span> grid<span class=\"token punctuation\">;</span>\n  <span class=\"token property\">grid-template-columns</span><span class=\"token punctuation\">:</span> auto <span class=\"token function\">minmax</span><span class=\"token punctuation\">(</span>min-content<span class=\"token punctuation\">,</span> 1fr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token property\">grid-template-rows</span><span class=\"token punctuation\">:</span> auto <span class=\"token function\">minmax</span><span class=\"token punctuation\">(</span>min-content<span class=\"token punctuation\">,</span> 1fr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token property\">max-width</span><span class=\"token punctuation\">:</span> 700px<span class=\"token punctuation\">;</span>\n  <span class=\"token property\">margin</span><span class=\"token punctuation\">:</span> 0 auto<span class=\"token punctuation\">;</span>\n  <span class=\"token property\">background-color</span><span class=\"token punctuation\">:</span> aliceblue<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>The site's <a href=\"/en-US/docs/Web/HTML/Element/body\"><code>&lt;body&gt;</code></a> is configured here to use one of a number of common sans-serif fonts, and to use <code>\"aliceblue\"</code> as the background color. Then the <code>\"wrapper\"</code> class is defined; it wraps the entire blog, including the header, sidebar, and body content (articles and ads).</p>\n<p>The wrapper establishes a CSS grid with two columns and two rows. The first column (sized automatically based on its content) is used for the sidebar and the second column (which will be used for body content) is sized to be at least the width of the contents of the column and at most all remaining available space.</p>\n<p>The first row will be used specially for the site header. The rows are sized the same way as the columns: the first one is automatically sized and the second one uses the remaining space, but at least enough space to provide room for all elements within it.</p>\n<p>The wrapper's width is fixed at 700px so that it will fit in the available space when presented inline on MDN below.</p>\n<h4 id=\"the_header\">The header</h4>\n<p>The header is fairly simple, since for this example all it contains is some text. Its style looks like this:</p>\n<div class=\"code-example\"><p class=\"example-header\"><span class=\"language-name\">css</span></p><pre class=\"brush: css notranslate\"><code><span class=\"token selector\">header</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">grid-column</span><span class=\"token punctuation\">:</span> 1 / -1<span class=\"token punctuation\">;</span>\n  <span class=\"token property\">grid-row</span><span class=\"token punctuation\">:</span> 1<span class=\"token punctuation\">;</span>\n  <span class=\"token property\">background-color</span><span class=\"token punctuation\">:</span> aliceblue<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p><a href=\"/en-US/docs/Web/CSS/grid-row\"><code>grid-row</code></a> is set to 1, since we want the header to be placed in the top row of the site's grid. More interesting is our use of <a href=\"/en-US/docs/Web/CSS/grid-column\"><code>grid-column</code></a> here; here we specify that we want the column to start in the first column and ends in the first column past the last grid line—in other words, the header spans across all of the columns within the grid. Perfect for our needs.</p>\n<h4 id=\"the_sidebar\">The sidebar</h4>\n<p>Our sidebar is used to present links to other pages on the site. None of them work in our example here, but they exist to help with the presentation of a blog-like experience. The sidebar is represented using an <a href=\"/en-US/docs/Web/HTML/Element/aside\"><code>&lt;aside&gt;</code></a> element, and is styled as follows:</p>\n<div class=\"code-example\"><p class=\"example-header\"><span class=\"language-name\">css</span></p><pre class=\"brush: css notranslate\"><code><span class=\"token selector\">aside</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">grid-column</span><span class=\"token punctuation\">:</span> 1<span class=\"token punctuation\">;</span>\n  <span class=\"token property\">grid-row</span><span class=\"token punctuation\">:</span> 2<span class=\"token punctuation\">;</span>\n  <span class=\"token property\">background-color</span><span class=\"token punctuation\">:</span> cornsilk<span class=\"token punctuation\">;</span>\n  <span class=\"token property\">padding</span><span class=\"token punctuation\">:</span> 5px 10px<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token selector\">aside ul</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">padding-left</span><span class=\"token punctuation\">:</span> 0<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token selector\">aside ul li</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">list-style</span><span class=\"token punctuation\">:</span> none<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token selector\">aside ul li a</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">text-decoration</span><span class=\"token punctuation\">:</span> none<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>The most important thing to note here is that the <a href=\"/en-US/docs/Web/CSS/grid-column\"><code>grid-column</code></a> is set to 1, to place the sidebar on the left-hand side of the screen. If you change this to -1, it will appear on the right (although some other elements will need some adjustments made to their margins to get the spacing just right). The <a href=\"/en-US/docs/Web/CSS/grid-row\"><code>grid-row</code></a> is set to 2, to place it alongside the site body.</p>\n<h4 id=\"the_content_body\">The content body</h4>\n<p>Speaking of the site's body: the main content of the site is kept in a <a href=\"/en-US/docs/Web/HTML/Element/main\"><code>&lt;main&gt;</code></a> element. The following style is applied to that:</p>\n<div class=\"code-example\"><p class=\"example-header\"><span class=\"language-name\">css</span></p><pre class=\"brush: css notranslate\"><code><span class=\"token selector\">main</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">grid-column</span><span class=\"token punctuation\">:</span> 2<span class=\"token punctuation\">;</span>\n  <span class=\"token property\">grid-row</span><span class=\"token punctuation\">:</span> 2<span class=\"token punctuation\">;</span>\n  <span class=\"token property\">margin</span><span class=\"token punctuation\">:</span> 0<span class=\"token punctuation\">;</span>\n  <span class=\"token property\">margin-left</span><span class=\"token punctuation\">:</span> 16px<span class=\"token punctuation\">;</span>\n  <span class=\"token property\">font-size</span><span class=\"token punctuation\">:</span> 16px<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>The primary feature here is that the grid position is set to place the body content in column 2, row 2.</p>\n<h4 id=\"articles\">Articles</h4>\n<p>Each article is contained in an <a href=\"/en-US/docs/Web/HTML/Element/article\"><code>&lt;article&gt;</code></a> element, styled like this:</p>\n<div class=\"code-example\"><p class=\"example-header\"><span class=\"language-name\">css</span></p><pre class=\"brush: css notranslate\"><code><span class=\"token selector\">article</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">background-color</span><span class=\"token punctuation\">:</span> white<span class=\"token punctuation\">;</span>\n  <span class=\"token property\">padding</span><span class=\"token punctuation\">:</span> 6px<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token selector\">article:not(:last-child)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">margin-bottom</span><span class=\"token punctuation\">:</span> 8px<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token selector\">article h2</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">margin-top</span><span class=\"token punctuation\">:</span> 0<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>This creates article boxes with a white background which float atop the blue background, with a small margin around the article. Every article which isn't the last item in the container has an 8px bottom margin to space things apart.</p>\n<h4 id=\"ads\">Ads</h4>\n<p>Finally, the ads have the following initial styling. Individual ads may customize the style somewhat, as we'll see later.</p>\n<div class=\"code-example\"><p class=\"example-header\"><span class=\"language-name\">css</span></p><pre class=\"brush: css notranslate\"><code><span class=\"token selector\">.ad</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">height</span><span class=\"token punctuation\">:</span> 96px<span class=\"token punctuation\">;</span>\n  <span class=\"token property\">padding</span><span class=\"token punctuation\">:</span> 6px<span class=\"token punctuation\">;</span>\n  <span class=\"token property\">border-color</span><span class=\"token punctuation\">:</span> #555<span class=\"token punctuation\">;</span>\n  <span class=\"token property\">border-style</span><span class=\"token punctuation\">:</span> solid<span class=\"token punctuation\">;</span>\n  <span class=\"token property\">border-width</span><span class=\"token punctuation\">:</span> 1px<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token selector\">.ad:not(:last-child)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">margin-bottom</span><span class=\"token punctuation\">:</span> 8px<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token selector\">.ad h2</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">margin-top</span><span class=\"token punctuation\">:</span> 0<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token selector\">.ad div</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">position</span><span class=\"token punctuation\">:</span> relative<span class=\"token punctuation\">;</span>\n  <span class=\"token property\">float</span><span class=\"token punctuation\">:</span> right<span class=\"token punctuation\">;</span>\n  <span class=\"token property\">padding</span><span class=\"token punctuation\">:</span> 0 4px<span class=\"token punctuation\">;</span>\n  <span class=\"token property\">height</span><span class=\"token punctuation\">:</span> 20px<span class=\"token punctuation\">;</span>\n  <span class=\"token property\">width</span><span class=\"token punctuation\">:</span> 120px<span class=\"token punctuation\">;</span>\n  <span class=\"token property\">font-size</span><span class=\"token punctuation\">:</span> 14px<span class=\"token punctuation\">;</span>\n  <span class=\"token property\">bottom</span><span class=\"token punctuation\">:</span> 30px<span class=\"token punctuation\">;</span>\n  <span class=\"token property\">border</span><span class=\"token punctuation\">:</span> 1px solid black<span class=\"token punctuation\">;</span>\n  <span class=\"token property\">background-color</span><span class=\"token punctuation\">:</span> <span class=\"token function\">rgba</span><span class=\"token punctuation\">(</span>255<span class=\"token punctuation\">,</span> 255<span class=\"token punctuation\">,</span> 255<span class=\"token punctuation\">,</span> 0.5<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>There's nothing magic in here. It's fairly basic CSS.</p>"}},{"type":"prose","value":{"id":"tying_it_together_with_javascript","title":"Tying it together with JavaScript","isH3":true,"content":"<p>That brings us to the JavaScript code which makes everything work. Let's start with the global variables:</p>\n<div class=\"code-example\"><p class=\"example-header\"><span class=\"language-name\">js</span></p><pre class=\"brush: js notranslate\"><code><span class=\"token keyword\">let</span> contentBox<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">let</span> nextArticleID <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> visibleAds <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Set</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">let</span> previouslyVisibleAds <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">let</span> adObserver<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">let</span> refreshIntervalID <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n</code></pre></div>\n<p>These are used as follows:</p>\n<dl>\n  <dt id=\"contentbox\"><a href=\"#contentbox\"><code>contentBox</code></a></dt>\n  <dd>\n    <p>A reference to the <a href=\"/en-US/docs/Web/HTML/Element/main\"><code>&lt;main&gt;</code></a> element's <a href=\"/en-US/docs/Web/API/HTMLElement\"><code>HTMLElement</code></a> object in the DOM. This is where we'll insert the articles and ads.</p>\n  </dd>\n  <dt id=\"nextarticleid\"><a href=\"#nextarticleid\"><code>nextArticleID</code></a></dt>\n  <dd>\n    <p>Each article is given a unique ID number; this variable tracks the next ID to use, starting with 1.</p>\n  </dd>\n  <dt id=\"visibleads\"><a href=\"#visibleads\"><code>visibleAds</code></a></dt>\n  <dd>\n    <p>A <a href=\"/en-US/docs/Web/JavaScript/Reference/Global_Objects/Set\"><code>Set</code></a> which we'll use to track the ads currently visible on the screen.</p>\n  </dd>\n  <dt id=\"previouslyvisibleads\"><a href=\"#previouslyvisibleads\"><code>previouslyVisibleAds</code></a></dt>\n  <dd>\n    <p>Used to temporarily store the list of visible ads while the document is not visible (for example, if the user has tabbed to another page).</p>\n  </dd>\n  <dt id=\"adobserver\"><a href=\"#adobserver\"><code>adObserver</code></a></dt>\n  <dd>\n    <p>Will hold our <a href=\"/en-US/docs/Web/API/IntersectionObserver\"><code>IntersectionObserver</code></a> used to track the intersection between the ads and the <code>&lt;main&gt;</code> element's bounds.</p>\n  </dd>\n  <dt id=\"refreshintervalid\"><a href=\"#refreshintervalid\"><code>refreshIntervalID</code></a></dt>\n  <dd>\n    <p>Used to store the interval ID returned by <a href=\"/en-US/docs/Web/API/setInterval\"><code>setInterval()</code></a>. This interval will be used to trigger our periodic refreshes of the ads' content.</p>\n  </dd>\n</dl>\n<h4 id=\"setting_up\">Setting up</h4>\n<p>To set things up, we run the <code>startup()</code> function below when the page loads:</p>\n<div class=\"code-example\"><p class=\"example-header\"><span class=\"language-name\">js</span></p><pre class=\"brush: js notranslate\"><code>window<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"load\"</span><span class=\"token punctuation\">,</span> startup<span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">startup</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  contentBox <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">querySelector</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"main\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  document<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"visibilitychange\"</span><span class=\"token punctuation\">,</span> handleVisibilityChange<span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">const</span> observerOptions <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token literal-property property\">root</span><span class=\"token operator\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">rootMargin</span><span class=\"token operator\">:</span> <span class=\"token string\">\"0px\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">threshold</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">0.0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0.75</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n  adObserver <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IntersectionObserver</span><span class=\"token punctuation\">(</span>intersectionCallback<span class=\"token punctuation\">,</span> observerOptions<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token function\">buildContents</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  refreshIntervalID <span class=\"token operator\">=</span> <span class=\"token function\">setInterval</span><span class=\"token punctuation\">(</span>handleRefreshInterval<span class=\"token punctuation\">,</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>First, a reference to the content wrapping <a href=\"/en-US/docs/Web/HTML/Element/main\"><code>&lt;main&gt;</code></a> element is obtained, so we can insert our content into it. Then we set up an event listener for the <a href=\"/en-US/docs/Web/API/Document/visibilitychange_event\" title=\"visibilitychange\"><code>visibilitychange</code></a> event. This event is sent when the document becomes hidden or visible, such as when the user switches tabs in their browser. The Intersection Observer API doesn't take this into account when detecting intersection, since intersection isn't affected by page visibility. Therefore, we need to pause our timers while the page is tabbed out; hence this event listener.</p>\n<p>Next we set up the options for the <a href=\"/en-US/docs/Web/API/IntersectionObserver\"><code>IntersectionObserver</code></a> which will monitor target elements (ads, in our case) for intersection changes relative to the document. The options are configured to watch for intersections with the document's viewport (by setting <code>root</code> to <code>null</code>). We have no margins to extend or contract the intersection root's rectangle; we want to match the boundaries of the document's viewport exactly for intersection purposes. And the <code>threshold</code> is set to an array containing the values 0.0 and 0.75; this will cause our callback to execute whenever a targeted element becomes completely obscured or first starts to become unobscured (intersection ratio 0.0) or passes through 75% visible in either direction (intersection ratio 0.75).</p>\n<p>The observer, <code>adObserver</code>, is created by calling <code>IntersectionObserver</code>'s constructor, passing in the callback function, <code>intersectionCallback</code>, and our options.</p>\n<p>We then call a function <code>buildContents()</code>, which we'll define later to actually generate and insert into the document the articles and ads we want to present.</p>\n<p>Finally, we set up an interval which triggers once a second to handle any necessary refreshing. We need a one second refresh since we're displaying timers in all visible ads for the purposes of this example. You may not need an interval at all, or you might do it differently or using a different time interval.</p>\n<h4 id=\"handling_document_visibility_changes\">Handling document visibility changes</h4>\n<p>Let's take a look at the handler for the <a href=\"/en-US/docs/Web/API/Document/visibilitychange_event\" title=\"visibilitychange\"><code>visibilitychange</code></a> event. Our script receives this event when the document itself becomes visible or invisible. The most important scenario here is when the user switches tabs. Since Intersection Observer only cares about the intersection between the targeted elements and the intersection root, and not the tab's visibility (which is a different issue entirely), we need to use the <a href=\"/en-US/docs/Web/API/Page_Visibility_API\">Page Visibility API</a> to detect these tab switches and disable our timers for the duration.</p>\n<div class=\"code-example\"><p class=\"example-header\"><span class=\"language-name\">js</span></p><pre class=\"brush: js notranslate\"><code><span class=\"token keyword\">function</span> <span class=\"token function\">handleVisibilityChange</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>document<span class=\"token punctuation\">.</span>hidden<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>previouslyVisibleAds<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      previouslyVisibleAds <span class=\"token operator\">=</span> visibleAds<span class=\"token punctuation\">;</span>\n      visibleAds <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n      previouslyVisibleAds<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">adBox</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=&gt;</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">updateAdTimer</span><span class=\"token punctuation\">(</span>adBox<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        adBox<span class=\"token punctuation\">.</span>dataset<span class=\"token punctuation\">.</span>lastViewStarted <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    previouslyVisibleAds<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">adBox</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=&gt;</span> <span class=\"token punctuation\">{</span>\n      adBox<span class=\"token punctuation\">.</span>dataset<span class=\"token punctuation\">.</span>lastViewStarted <span class=\"token operator\">=</span> performance<span class=\"token punctuation\">.</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    visibleAds <span class=\"token operator\">=</span> previouslyVisibleAds<span class=\"token punctuation\">;</span>\n    previouslyVisibleAds <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>Since the event itself doesn't state whether the document has switched from visible to invisible or vice versa, the <a href=\"/en-US/docs/Web/API/Document/hidden\"><code>document.hidden</code></a> property is checked to see if the document is not currently visible. Since it's theoretically possible to get called multiple times, we only proceed if we haven't already paused the timers and saved the visibility states of the existing ads.</p>\n<p>To pause the timers, all we need to do is remove the ads from the set of visible ads (<code>visibleAds</code>) and mark them as inactive. To do so, we begin by saving the set of visible ads into a variable known as <code>previouslyVisibleAds</code> to be sure we can restore them when the user tabs back into the document, and we then empty the <code>visibleAds</code> set so they won't be treated as visible. Then, for each of the ads that are being suspended, we call our <code>updateAdTimer()</code> function, which handles updating the ad's total visible time counter, then we set their <code>dataset.lastViewStarted</code> property to 0, which indicates that the tab's timer isn't running.</p>\n<p>If the document has just become visible, we reverse this process: first we go through <code>previouslyVisibleAds</code> and set each one's <code>dataset.lastViewStarted</code> to the current document's time (in milliseconds since the document was created) using the <a href=\"/en-US/docs/Web/API/Performance/now\" title=\"performance.now()\"><code>performance.now()</code></a> method. Then we set <code>visibleAds</code> back to <code>previouslyVisibleAds</code> and set the latter to <code>null</code>. Now the ads are all restarted, and configured to know that they became visible at the current time, so that they will not add up the duration of time the page was tabbed away the next time they're updated.</p>\n<h4 id=\"handling_intersection_changes\">Handling intersection changes</h4>\n<p>Once per pass through the browser's event loop, each <a href=\"/en-US/docs/Web/API/IntersectionObserver\"><code>IntersectionObserver</code></a> checks to see if any of its target elements have passed through any of the observer's intersection ratio thresholds. For each observer, a list of targets that have done so is compiled, and sent to the observer's callback as an array of <a href=\"/en-US/docs/Web/API/IntersectionObserverEntry\"><code>IntersectionObserverEntry</code></a> objects. Our callback, <code>intersectionCallback()</code>, looks like this:</p>\n<div class=\"code-example\"><p class=\"example-header\"><span class=\"language-name\">js</span></p><pre class=\"brush: js notranslate\"><code><span class=\"token keyword\">function</span> <span class=\"token function\">intersectionCallback</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">entries</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  entries<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">entry</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=&gt;</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> adBox <span class=\"token operator\">=</span> entry<span class=\"token punctuation\">.</span>target<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>entry<span class=\"token punctuation\">.</span>isIntersecting<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>entry<span class=\"token punctuation\">.</span>intersectionRatio <span class=\"token operator\">&gt;=</span> <span class=\"token number\">0.75</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        adBox<span class=\"token punctuation\">.</span>dataset<span class=\"token punctuation\">.</span>lastViewStarted <span class=\"token operator\">=</span> entry<span class=\"token punctuation\">.</span>time<span class=\"token punctuation\">;</span>\n        visibleAds<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>adBox<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n      visibleAds<span class=\"token punctuation\">.</span><span class=\"token function\">delete</span><span class=\"token punctuation\">(</span>adBox<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>\n        entry<span class=\"token punctuation\">.</span>intersectionRatio <span class=\"token operator\">===</span> <span class=\"token number\">0.0</span> <span class=\"token operator\">&amp;&amp;</span>\n        adBox<span class=\"token punctuation\">.</span>dataset<span class=\"token punctuation\">.</span>totalViewTime <span class=\"token operator\">&gt;=</span> <span class=\"token number\">60000</span>\n      <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">replaceAd</span><span class=\"token punctuation\">(</span>adBox<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>As previously mentioned, the <a href=\"/en-US/docs/Web/API/IntersectionObserver\"><code>IntersectionObserver</code></a> callback receives as input an array of all of the observer's targeted elements which have become either more or less visible than one of the intersection observer ratios. We iterate over each of those entries—which are of type <a href=\"/en-US/docs/Web/API/IntersectionObserverEntry\"><code>IntersectionObserverEntry</code></a>. If the target element is intersecting with the root, we know it has just transitioned from the obscured state to the visible state. If it's become at least 75% visible, then we consider the ad visible and we start the timer by setting the ad's <code>dataset.lastViewStarted</code> attribute to the transition time in <a href=\"/en-US/docs/Web/API/IntersectionObserverEntry/time\" title=\"entry.time\"><code>entry.time</code></a>, then add the ad to the set <code>visibleAds</code> so we know to process it as time goes by.</p>\n<p>If the ad has transitioned to the not-intersecting state, we remove the ad from the set of visible ads. Then we have one special behavior: we look to see if <a href=\"/en-US/docs/Web/API/IntersectionObserverEntry/intersectionRatio\" title=\"entry.ratio\"><code>entry.ratio</code></a> is 0.0; if it is, that means the element has become totally obscured. If that's the case, and the ad has been visible for at least a minute total, we call a function we'll create called <code>replaceAd()</code> to replace the existing ad with a new one. This way, the user sees a variety of ads over time, but the ads are only replaced while they can't be seen, resulting in a smooth experience.</p>\n<h4 id=\"handling_periodic_actions\">Handling periodic actions</h4>\n<p>Our interval handler, <code>handleRefreshInterval()</code>, is called about once per second courtesy of the call to <a href=\"/en-US/docs/Web/API/setInterval\"><code>setInterval()</code></a> made in the <code>startup()</code> function <a href=\"#setting_up\">described above</a>. Its main job is to update the timers every second and schedule a redraw to update the timers we'll be drawing within each ad.</p>\n<div class=\"code-example\"><p class=\"example-header\"><span class=\"language-name\">js</span></p><pre class=\"brush: js notranslate\"><code><span class=\"token keyword\">function</span> <span class=\"token function\">handleRefreshInterval</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> redrawList <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n  visibleAds<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">adBox</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=&gt;</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> previousTime <span class=\"token operator\">=</span> adBox<span class=\"token punctuation\">.</span>dataset<span class=\"token punctuation\">.</span>totalViewTime<span class=\"token punctuation\">;</span>\n    <span class=\"token function\">updateAdTimer</span><span class=\"token punctuation\">(</span>adBox<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>previousTime <span class=\"token operator\">!==</span> adBox<span class=\"token punctuation\">.</span>dataset<span class=\"token punctuation\">.</span>totalViewTime<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      redrawList<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>adBox<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>redrawList<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    window<span class=\"token punctuation\">.</span><span class=\"token function\">requestAnimationFrame</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">time</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=&gt;</span> <span class=\"token punctuation\">{</span>\n      redrawList<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">adBox</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=&gt;</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">drawAdTimer</span><span class=\"token punctuation\">(</span>adBox<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>The array <code>redrawList</code> will be used to keep a list of all the ads which need to be redrawn during this refresh cycle, since it may not be exactly the same as the elapsed time due to system activity or because you've set the interval to something other than every 1000 milliseconds.</p>\n<p>Then, for each of the visible ads, we save the value of <code>dataset.totalViewTime</code> (the total number of milliseconds the ad has currently been visible, as of the last time it was updated) and then call <code>updateAdTimer()</code> to update the time. If it's changed, then we push the ad onto the <code>redrawList</code> so we know it needs to be updated during the next animation frame.</p>\n<p>Finally, if there's at least one element to redraw, we use <a href=\"/en-US/docs/Web/API/window/requestAnimationFrame\" title=\"requestAnimationFrame()\"><code>requestAnimationFrame()</code></a> to schedule a function that will redraw each element in the <code>redrawList</code> during the next animation frame.</p>\n<h4 id=\"updating_an_ads_visibility_timer\">Updating an ad's visibility timer</h4>\n<p>Previously (see <a href=\"#handling_document_visibility_changes\">Handling document visibility changes</a> and <a href=\"#handling_periodic_actions\">Handling periodic actions</a>), we've seen that when we need to update an ad's \"total visible time\" counter, we call a function named <code>updateAdTimer()</code> to do so. This function takes as an input an ad's <a href=\"/en-US/docs/Web/API/HTMLDivElement\"><code>HTMLDivElement</code></a> object. Here it is:</p>\n<div class=\"code-example\"><p class=\"example-header\"><span class=\"language-name\">js</span></p><pre class=\"brush: js notranslate\"><code><span class=\"token keyword\">function</span> <span class=\"token function\">updateAdTimer</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">adBox</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> lastStarted <span class=\"token operator\">=</span> adBox<span class=\"token punctuation\">.</span>dataset<span class=\"token punctuation\">.</span>lastViewStarted<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> currentTime <span class=\"token operator\">=</span> performance<span class=\"token punctuation\">.</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>lastStarted<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> diff <span class=\"token operator\">=</span> currentTime <span class=\"token operator\">-</span> lastStarted<span class=\"token punctuation\">;</span>\n\n    adBox<span class=\"token punctuation\">.</span>dataset<span class=\"token punctuation\">.</span>totalViewTime <span class=\"token operator\">=</span>\n      <span class=\"token function\">parseFloat</span><span class=\"token punctuation\">(</span>adBox<span class=\"token punctuation\">.</span>dataset<span class=\"token punctuation\">.</span>totalViewTime<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> diff<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  adBox<span class=\"token punctuation\">.</span>dataset<span class=\"token punctuation\">.</span>lastViewStarted <span class=\"token operator\">=</span> currentTime<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>To track an element's visible time, we use two custom data attributes (see <a href=\"/en-US/docs/Web/HTML/Global_attributes#data-*\"><code>data-*</code></a>) on every ad:</p>\n<dl>\n  <dt id=\"lastviewstarted\"><a href=\"#lastviewstarted\"><code>lastViewStarted</code></a></dt>\n  <dd>\n    <p>The time in milliseconds, relative to the time at which the document was created, at which the ad's visibility count was last updated, or the ad last became visible. 0 if the ad was not visible as of the last time it was checked.</p>\n  </dd>\n  <dt id=\"totalviewtime\"><a href=\"#totalviewtime\"><code>totalViewTime</code></a></dt>\n  <dd>\n    <p>The total number of milliseconds the ad has been visible.</p>\n  </dd>\n</dl>\n<p>These are accessed through each ad's <a href=\"/en-US/docs/Web/API/HTMLElement/dataset\"><code>HTMLElement.dataset</code></a> attribute, which provides a <a href=\"/en-US/docs/Web/API/DOMStringMap\"><code>DOMStringMap</code></a> mapping each custom attribute's name to its value. The values are strings, but we can convert those to numbers easily enough—in fact, JavaScript generally does it automatically, although we'll have one instance where we have to do it ourselves.</p>\n<p>We start by fetching the time at which the ad's previous visibility status check time (<code>adBox.dataset.lastViewStarted</code>) into a local variable named <code>lastStarted</code>. We also get the current time-since-creation value using <a href=\"/en-US/docs/Web/API/Performance/now\" title=\"performance.now()\"><code>performance.now()</code></a> into <code>currentTime</code>.</p>\n<p>If <code>lastStarted</code> is non-zero—meaning the timer is currently running, we compute the difference between the current time and the start time to determine the number of milliseconds the timer has been visible since the last time it became visible. This is added to the current value of the ad's <code>totalViewTime</code> to bring the total up to date. Note the use of <a href=\"/en-US/docs/Web/JavaScript/Reference/Global_Objects/parseFloat\"><code>parseFloat()</code></a> here; because these values are strings, JavaScript tries to do a string concatenation instead of addition without it.</p>\n<p>Finally, the last-viewed time for the ad is updated to the current time. This is done whether the ad was running when this function was called or not; this causes the ad's timer to always be running when this function returns. This makes sense because this function is only called if the ad is visible, even if it's just now become visible.</p>\n<h4 id=\"drawing_an_ads_timer\">Drawing an ad's timer</h4>\n<p>Inside each ad, for demonstration purposes, we draw the current value of its <code>totalViewTime</code>, converted into minutes and seconds. This is handled by passing the ad's element into the <code>drawAdTimer()</code> function:</p>\n<div class=\"code-example\"><p class=\"example-header\"><span class=\"language-name\">js</span></p><pre class=\"brush: js notranslate\"><code><span class=\"token keyword\">function</span> <span class=\"token function\">drawAdTimer</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">adBox</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> timerBox <span class=\"token operator\">=</span> adBox<span class=\"token punctuation\">.</span><span class=\"token function\">querySelector</span><span class=\"token punctuation\">(</span><span class=\"token string\">\".timer\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> totalSeconds <span class=\"token operator\">=</span> adBox<span class=\"token punctuation\">.</span>dataset<span class=\"token punctuation\">.</span>totalViewTime <span class=\"token operator\">/</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> sec <span class=\"token operator\">=</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">floor</span><span class=\"token punctuation\">(</span>totalSeconds <span class=\"token operator\">%</span> <span class=\"token number\">60</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> min <span class=\"token operator\">=</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">floor</span><span class=\"token punctuation\">(</span>totalSeconds <span class=\"token operator\">/</span> <span class=\"token number\">60</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  timerBox<span class=\"token punctuation\">.</span>innerText <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>min<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">:</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>sec<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">padStart</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"0\"</span><span class=\"token punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>This code finds the ad's timer using its ID, <code>\"timer\"</code>, and computes the number of seconds elapsed by dividing the ad's <code>totalViewTime</code> by 1000. Then it calculates the number of minutes and seconds elapsed before setting the timer's <a href=\"/en-US/docs/Web/API/HTMLElement/innerText\" title=\"innerText\"><code>innerText</code></a> to a string representing that time in the form m:ss. The <a href=\"/en-US/docs/Web/JavaScript/Reference/Global_Objects/String/padStart\"><code>String.padStart()</code></a> method is used to ensure that the number of seconds is padded out to two digits if it's less than 10.</p>\n<h4 id=\"building_the_page_contents\">Building the page contents</h4>\n<p>The <code>buildContents()</code> function is called by the <a href=\"#setting_up\">startup code</a> to select and insert into the document the articles and ads to be presented:</p>\n<div class=\"code-example\"><p class=\"example-header\"><span class=\"language-name\">js</span></p><pre class=\"brush: js notranslate\"><code><span class=\"token keyword\">const</span> loremIpsum <span class=\"token operator\">=</span>\n  <span class=\"token string\">\"&lt;p&gt;Lorem ipsum dolor sit amet, consectetur adipiscing\"</span> <span class=\"token operator\">+</span>\n  <span class=\"token string\">\" elit. Cras at sem diam. Vestibulum venenatis massa in tincidunt\"</span> <span class=\"token operator\">+</span>\n  <span class=\"token string\">\" egestas. Morbi eu lorem vel est sodales auctor hendrerit placerat\"</span> <span class=\"token operator\">+</span>\n  <span class=\"token string\">\" risus. Etiam rutrum faucibus sem, vitae mattis ipsum ullamcorper\"</span> <span class=\"token operator\">+</span>\n  <span class=\"token string\">\" eu. Donec nec imperdiet nibh, nec vehicula libero. Phasellus vel\"</span> <span class=\"token operator\">+</span>\n  <span class=\"token string\">\" malesuada nulla. Aliquam sed magna aliquam, vestibulum nisi at,\"</span> <span class=\"token operator\">+</span>\n  <span class=\"token string\">\" cursus nunc.&lt;/p&gt;\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">buildContents</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token number\">5</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    contentBox<span class=\"token punctuation\">.</span><span class=\"token function\">appendChild</span><span class=\"token punctuation\">(</span><span class=\"token function\">createArticle</span><span class=\"token punctuation\">(</span>loremIpsum<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token punctuation\">(</span>i <span class=\"token operator\">%</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">loadRandomAd</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>The variable <code>loremIpsum</code> contains the text we'll use for the body of all of our articles. Obviously in the real world, you'd have some code to pull articles from a database or the like, but this does the job for our purposes. Every article uses the same text; you could of course change that easily enough.</p>\n<p><code>buildContents()</code> creates a page with five articles. Following every odd-numbered article, an ad is \"loaded\" and inserted into the page. Articles are inserted into the content box (that is, the <a href=\"/en-US/docs/Web/HTML/Element/main\"><code>&lt;main&gt;</code></a> element that contains all the site content) after being created using a method called <code>createArticle()</code>, which we'll look at next.</p>\n<p>The ads are created using a function called <code>loadRandomAd()</code>, which both creates the ad and inserts it into the page. We'll see later that this same function can also replace an existing ad, but for now, we're appending ads to the existing content.</p>\n<h4 id=\"creating_an_article\">Creating an article</h4>\n<p>To create the <a href=\"/en-US/docs/Web/HTML/Element/article\"><code>&lt;article&gt;</code></a> element for an article (as well as all of its contents), we use the <code>createArticle()</code> function, which takes as input a string which is the full text of the article to add to the page.</p>\n<div class=\"code-example\"><p class=\"example-header\"><span class=\"language-name\">js</span></p><pre class=\"brush: js notranslate\"><code><span class=\"token keyword\">function</span> <span class=\"token function\">createArticle</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">contents</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> articleElem <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"article\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  articleElem<span class=\"token punctuation\">.</span>id <span class=\"token operator\">=</span> nextArticleID<span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">const</span> titleElem <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"h2\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  titleElem<span class=\"token punctuation\">.</span>innerText <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Article </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>nextArticleID<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\"> title</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span>\n  articleElem<span class=\"token punctuation\">.</span><span class=\"token function\">appendChild</span><span class=\"token punctuation\">(</span>titleElem<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  articleElem<span class=\"token punctuation\">.</span>innerHTML <span class=\"token operator\">+=</span> contents<span class=\"token punctuation\">;</span>\n  nextArticleID <span class=\"token operator\">+=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">return</span> articleElem<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>First, the <code>&lt;article&gt;</code> element is created and its ID is set to the unique value <code>nextArticleID</code> (which starts at 1 and goes up for each article). Then we create and append an <a href=\"/en-US/docs/Web/HTML/Element/Heading_Elements\">h2</a> element for the article title and then we append the HTML from <code>contents</code> to that. Finally, <code>nextArticleID</code> is incremented (so that the next element gets a new unique ID) and we return the new <code>&lt;article&gt;</code> element to the caller.</p>\n<h4 id=\"creating_an_ad\">Creating an ad</h4>\n<p>The <code>loadRandomAd()</code> function simulates loading an ad and adding it to the page. If you don't pass a value for <code>replaceBox</code>, a new element is created to contain the ad; the ad is then appended to the page. If you specify a <code>replaceBox</code>, that box is treated as an existing ad element; instead of creating a new one, the existing element is changed to contain the new ad's style, content, and other data. This avoids the risk of lengthy layout work being done when you update the ad, which could happen if you first delete the old element then insert a new one.</p>\n<div class=\"code-example\"><p class=\"example-header\"><span class=\"language-name\">js</span></p><pre class=\"brush: js notranslate\"><code><span class=\"token keyword\">function</span> <span class=\"token function\">loadRandomAd</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">replaceBox</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> ads <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">{</span>\n      <span class=\"token literal-property property\">bgcolor</span><span class=\"token operator\">:</span> <span class=\"token string\">\"#cec\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token literal-property property\">title</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Eat Green Beans\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token literal-property property\">body</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Make your mother proud—they're good for you!\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">{</span>\n      <span class=\"token literal-property property\">bgcolor</span><span class=\"token operator\">:</span> <span class=\"token string\">\"aquamarine\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token literal-property property\">title</span><span class=\"token operator\">:</span> <span class=\"token string\">\"MillionsOfFreeBooks.whatever\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token literal-property property\">body</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Read classic literature online free!\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">{</span>\n      <span class=\"token literal-property property\">bgcolor</span><span class=\"token operator\">:</span> <span class=\"token string\">\"lightgrey\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token literal-property property\">title</span><span class=\"token operator\">:</span> <span class=\"token string\">\"3.14 Shades of Gray: A novel\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token literal-property property\">body</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Love really does make the world go round…\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">{</span>\n      <span class=\"token literal-property property\">bgcolor</span><span class=\"token operator\">:</span> <span class=\"token string\">\"#fee\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token literal-property property\">title</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Flexbox Florist\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token literal-property property\">body</span><span class=\"token operator\">:</span> <span class=\"token string\">\"When life's layout gets complicated, send flowers.\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">let</span> adBox<span class=\"token punctuation\">,</span> title<span class=\"token punctuation\">,</span> body<span class=\"token punctuation\">,</span> timerElem<span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">const</span> ad <span class=\"token operator\">=</span> ads<span class=\"token punctuation\">[</span>Math<span class=\"token punctuation\">.</span><span class=\"token function\">floor</span><span class=\"token punctuation\">(</span>Math<span class=\"token punctuation\">.</span><span class=\"token function\">random</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> ads<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>replaceBox<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    adObserver<span class=\"token punctuation\">.</span><span class=\"token function\">unobserve</span><span class=\"token punctuation\">(</span>replaceBox<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    adBox <span class=\"token operator\">=</span> replaceBox<span class=\"token punctuation\">;</span>\n    title <span class=\"token operator\">=</span> replaceBox<span class=\"token punctuation\">.</span><span class=\"token function\">querySelector</span><span class=\"token punctuation\">(</span><span class=\"token string\">\".title\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    body <span class=\"token operator\">=</span> replaceBox<span class=\"token punctuation\">.</span><span class=\"token function\">querySelector</span><span class=\"token punctuation\">(</span><span class=\"token string\">\".body\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    timerElem <span class=\"token operator\">=</span> replaceBox<span class=\"token punctuation\">.</span><span class=\"token function\">querySelector</span><span class=\"token punctuation\">(</span><span class=\"token string\">\".timer\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    adBox <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"div\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    adBox<span class=\"token punctuation\">.</span>className <span class=\"token operator\">=</span> <span class=\"token string\">\"ad\"</span><span class=\"token punctuation\">;</span>\n    title <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"h2\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    body <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"p\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    timerElem <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"div\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    adBox<span class=\"token punctuation\">.</span><span class=\"token function\">appendChild</span><span class=\"token punctuation\">(</span>title<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    adBox<span class=\"token punctuation\">.</span><span class=\"token function\">appendChild</span><span class=\"token punctuation\">(</span>body<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    adBox<span class=\"token punctuation\">.</span><span class=\"token function\">appendChild</span><span class=\"token punctuation\">(</span>timerElem<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  adBox<span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>backgroundColor <span class=\"token operator\">=</span> ad<span class=\"token punctuation\">.</span>bgcolor<span class=\"token punctuation\">;</span>\n\n  title<span class=\"token punctuation\">.</span>className <span class=\"token operator\">=</span> <span class=\"token string\">\"title\"</span><span class=\"token punctuation\">;</span>\n  body<span class=\"token punctuation\">.</span>className <span class=\"token operator\">=</span> <span class=\"token string\">\"body\"</span><span class=\"token punctuation\">;</span>\n  title<span class=\"token punctuation\">.</span>innerText <span class=\"token operator\">=</span> ad<span class=\"token punctuation\">.</span>title<span class=\"token punctuation\">;</span>\n  body<span class=\"token punctuation\">.</span>innerHTML <span class=\"token operator\">=</span> ad<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">;</span>\n\n  adBox<span class=\"token punctuation\">.</span>dataset<span class=\"token punctuation\">.</span>totalViewTime <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n  adBox<span class=\"token punctuation\">.</span>dataset<span class=\"token punctuation\">.</span>lastViewStarted <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n\n  timerElem<span class=\"token punctuation\">.</span>className <span class=\"token operator\">=</span> <span class=\"token string\">\"timer\"</span><span class=\"token punctuation\">;</span>\n  timerElem<span class=\"token punctuation\">.</span>innerText <span class=\"token operator\">=</span> <span class=\"token string\">\"0:00\"</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>replaceBox<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    contentBox<span class=\"token punctuation\">.</span><span class=\"token function\">appendChild</span><span class=\"token punctuation\">(</span>adBox<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  adObserver<span class=\"token punctuation\">.</span><span class=\"token function\">observe</span><span class=\"token punctuation\">(</span>adBox<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>First is the array <code>ads</code>. This array contains the data needed to create each ad. We have four here to choose from at random. In a real-world scenario, of course, the ads would come from a database or, more likely, an advertising service from which you fetch ads using an API. However, our needs are simple: each ad is represented by an object with three properties: a background color (<code>bgcolor</code>), a title (<code>title</code>), and a body text string (<code>body</code>).</p>\n<p>Then we define several variables:</p>\n<dl>\n  <dt id=\"adbox\"><a href=\"#adbox\"><code>adBox</code></a></dt>\n  <dd>\n    <p>This will be set to the element that represents the ad. For new ads being appended to the page, this is created using <a href=\"/en-US/docs/Web/API/Document/createElement\"><code>Document.createElement()</code></a>. When replacing an existing ad, this is set to the specified ad element (<code>replaceBox</code>).</p>\n  </dd>\n  <dt id=\"title\"><a href=\"#title\"><code>title</code></a></dt>\n  <dd>\n    <p>Will hold the <a href=\"/en-US/docs/Web/HTML/Element/Heading_Elements\">h2</a> element representing the ad's title.</p>\n  </dd>\n  <dt id=\"body\"><a href=\"#body\"><code>body</code></a></dt>\n  <dd>\n    <p>Will hold the <a href=\"/en-US/docs/Web/HTML/Element/p\"><code>&lt;p&gt;</code></a> representing the ad's body text.</p>\n  </dd>\n  <dt id=\"timerelem\"><a href=\"#timerelem\"><code>timerElem</code></a></dt>\n  <dd>\n    <p>Will hold the <a href=\"/en-US/docs/Web/HTML/Element/div\"><code>&lt;div&gt;</code></a> element which contains the time the ad has been visible so far.</p>\n  </dd>\n</dl>\n<p>A random ad is selected by computing <code>Math.floor(Math.random() * ads.length)</code>; the result is a value between 0 and one less than the number of ads. The corresponding ad is now known as <code>adBox</code>.</p>\n<p>If a value is specified for <code>replaceBox</code>, we use that as the ad element. To do so, we begin by ending observation of the element by calling <a href=\"/en-US/docs/Web/API/IntersectionObserver/unobserve\"><code>IntersectionObserver.unobserve()</code></a>. Then the local variables for each of the elements that comprise an ad: the ad box itself, the title, the body, and the timer box, are all set to the corresponding elements in the existing ad.</p>\n<p>If no value is specified for replaceBox, we create a new ad element. The ad's new <a href=\"/en-US/docs/Web/HTML/Element/div\"><code>&lt;div&gt;</code></a> element is created and its properties established by setting its class name to <code>\"ad\"</code>. Next, the ad title element is created, along with the body and the visibility timer; these are an <a href=\"/en-US/docs/Web/HTML/Element/Heading_Elements\">h2</a>, a <a href=\"/en-US/docs/Web/HTML/Element/p\"><code>&lt;p&gt;</code></a>, and a <a href=\"/en-US/docs/Web/HTML/Element/div\"><code>&lt;div&gt;</code></a> element, respectively. These elements are appended to the <code>adBox</code> element.</p>\n<p>After that, the code paths converge once again. The ad's background color is set to the value specified in the new ad's record, and elements' classes and contents are set appropriately as well.</p>\n<p>Next, it's time to set up the custom data properties to track the ad's visibility data by setting <code>adBox.dataset.totalViewTime</code> and <code>adBox.dataset.lastViewStarted</code> to 0.</p>\n<p>Finally, we set the ID of the <code>&lt;div&gt;</code> which will show the timer we'll present in the ad to show how long it's been visible, giving it the class <code>\"timer\"</code>. The initial text is set to \"0:00\", to represent the starting time of 0 minutes and 0 seconds, and it's appended to the ad.</p>\n<p>If we're not replacing an existing ad, we need to append the element to the content area of the page using <a href=\"/en-US/docs/Web/API/Node/appendChild\" title=\"Document.appendChild()\"><code>Document.appendChild()</code></a>. If we're replacing an ad, it's already there, with its contents replaced with the new ad's. Then we call the <a href=\"/en-US/docs/Web/API/IntersectionObserver/observe\" title=\"observe()\"><code>observe()</code></a> method on our Intersection Observer, <code>adObserver</code>, to start watching the ad for changes to its intersection with the viewport. From now on, any time the ad becomes 100% obscured or even a single pixel becomes visible, or the ad passes through 75% visible in one way or another, the <a href=\"#handling_intersection_changes\">observer's callback</a> is executed.</p>\n<h4 id=\"replacing_an_existing_ad\">Replacing an existing ad</h4>\n<p>Our <a href=\"#handling_intersection_changes\">observer's callback</a> keeps an eye out for ads which become 100% obscured and have a total visible time of at least one minute. When that happens, the <code>replaceAd()</code> function is called with that ad's element as an input, so that the old ad can be replaced with a new one.</p>\n<div class=\"code-example\"><p class=\"example-header\"><span class=\"language-name\">js</span></p><pre class=\"brush: js notranslate\"><code><span class=\"token keyword\">function</span> <span class=\"token function\">replaceAd</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">adBox</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">updateAdTimer</span><span class=\"token punctuation\">(</span>adBox<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">const</span> visibleTime <span class=\"token operator\">=</span> adBox<span class=\"token punctuation\">.</span>dataset<span class=\"token punctuation\">.</span>totalViewTime<span class=\"token punctuation\">;</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>\n    <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Replacing ad: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>\n      adBox<span class=\"token punctuation\">.</span><span class=\"token function\">querySelector</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"h2\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>innerText\n    <span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\"> - visible for </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>visibleTime<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token function\">loadRandomAd</span><span class=\"token punctuation\">(</span>adBox<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p><code>replaceAd()</code> begins by calling <code>updateAdTimer()</code> on the existing ad, to ensure that its timer is up-to-date. This ensures that when we read its <code>totalViewTime</code>, we see the exact final value for how long the ad was visible to the user. We then report that data; in this case, by logging it to console, but in the real world, you'd submit the information to an ad service's API or save it into a database.</p>\n<p>Then we load a new ad by calling <a href=\"#creating_an_ad\"><code>loadRandomAd()</code></a>, specifying the ad to be replaced as an input parameter. As we saw previously, <code>loadRandomAd()</code> will replace an existing ad with content and data corresponding to a new ad, if you specify an existing ad's element as an input parameter.</p>\n<p>The new ad's element object is returned to the caller in case it's needed.</p>"}},{"type":"prose","value":{"id":"result","title":"Result","isH3":true,"content":"<p>The resulting page looks like this. Try experimenting by scrolling up and down and notice how changes in the visibility affect the timers in each ad. Also note that each ad is replaced after one minute of visibility (but the ad must first be scrolled out of view and back again), and how the timers pause while the document is tabbed into the background. However, covering the browser with another window does not pause the timers.</p><div class=\"code-example\" id=\"sect1\"><p class=\"example-header\"></p><iframe class=\"sample-code-frame\" title=\"Building the site sample\" id=\"frame_building_the_site\" width=\"750\" height=\"800\" src=\"http://localhost:5042/en-US/docs/Web/API/Intersection_Observer_API/Timing_element_visibility/runner.html?id=building_the_site\" loading=\"lazy\"></iframe></div>"}},{"type":"prose","value":{"id":"see_also","title":"See also","isH3":false,"content":"<ul>\n  <li><a href=\"/en-US/docs/Web/API/Intersection_Observer_API\">Intersection Observer API</a></li>\n  <li><a href=\"/en-US/docs/Web/API/Page_Visibility_API\">Page Visibility API</a></li>\n</ul>"}}],"toc":[{"text":"Building the site","id":"building_the_site"},{"text":"See also","id":"see_also"}],"summary":"In this article, we'll build a mock blog which has a number of ads interspersed among the contents of the page, then use the Intersection Observer API to track how much time each ad is visible to the user. When an ad exceeds one minute of visible time, it will be replaced with a new one.","popularity":0.0076,"modified":"2023-07-17T23:17:51.000Z","source":{"folder":"en-us/web/api/intersection_observer_api/timing_element_visibility","github_url":"https://github.com/mdn/content/blob/main/files/en-us/web/api/intersection_observer_api/timing_element_visibility/index.md","last_commit_url":"https://github.com/mdn/content/commit/76717f752447b6eef25bf29c12272e407ee5cb6b","filename":"index.md"},"short_title":"Timing element visibility with the Intersection Observer API","parents":[{"uri":"/en-US/docs/Web","title":"References"},{"uri":"/en-US/docs/Web/API","title":"Web APIs"},{"uri":"/en-US/docs/Web/API/Intersection_Observer_API","title":"Intersection Observer API"},{"uri":"/en-US/docs/Web/API/Intersection_Observer_API/Timing_element_visibility","title":"Timing element visibility with the Intersection Observer API"}],"pageTitle":"Timing element visibility with the Intersection Observer API - Web APIs | MDN","noIndexing":false}}</script></body></html>